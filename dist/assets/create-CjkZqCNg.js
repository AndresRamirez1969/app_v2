import{_ as se,A as re,J as f,ah as H,K as ie,a0 as ue,B as M,ai as G,s as I,l as U,a as t,w as s,V as L,b as y,c as N,d as c,C as k,al as de,f as J,aj as me,H as K,aw as v,e as p,aA as ce,U as V,b4 as fe,b5 as Q,p as pe,b6 as ge,b7 as ye,t as z,u as ve,aq as be,aB as _e,a8 as Ve,L as ze,b8 as xe,o as x}from"./index-DA8Oyi7H.js";import{j as he}from"./mdi-CCqP_oQm.js";import{t as W,A as we}from"./timezones-D96QrXPD.js";import{f as O,t as ke}from"./countries-Ba2Yp21G.js";const Ce={key:0},Ae=["src"],Ue={key:1,style:{width:"300px",height:"300px",display:"flex","align-items":"center","justify-content":"center",background:"#f5f5f5","border-radius":"12px"}},$e={class:"phone-group phone-group-responsive mt-2"},Fe={style:{"margin-left":"6px"}},Re={class:"d-flex align-center justify-space-between"},Se={style:{"margin-left":"8px"}},Ie={class:"text-medium-emphasis"},Le={__name:"create",setup(je){const C=re(),$=ue(),Z=f(null),b=f({}),j=f(null),_=f(""),E=f(!1),D=f(""),B=f("");function h(l){return l?l.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function F(l=""){return h(String(l).replace(/\s*\(\+\d+\)\s*$/,"").trim())}function R(l,e=""){const a=O(l),i=(a==null?void 0:a.dial_code)??(a==null?void 0:a.calling_code)??(a==null?void 0:a.callingCode)??(a==null?void 0:a.phoneCode)??null;if(i)return String(i).startsWith("+")?i:`+${i}`;const n=String(e).match(/\(\+[\d]+\)/);return n&&n[0]?n[0].replace(/[()]/g,""):""}function X(l,e){const a=i=>{const n=R(i.value,i.title);let r=0;return n&&(r+=2),i.value&&(r+=1),String(i.value||"").length<=3&&(r+=1),r};return a(l)>=a(e)?l:e}function Y(){const l=ke(),e=new Set,a=l.filter(r=>e.has(r.value)?!1:(e.add(r.value),!0)),i=new Map;for(const r of a){const u=F(r.title),g=i.get(u);g?i.set(u,X(g,r)):i.set(u,r)}const n=Array.from(i.values()).map(r=>({...r,title:r.title.replace(/\s*\(\+\d+\)\s*$/,"").trim()}));return n.sort((r,u)=>F(r.title).localeCompare(F(u.title))),n}const d=H({legal_name:"",timezone:"",address:"",logo:"",phone_country:""}),ee={legal_name:f(null),timezone:f(null),address:f(null),logo:f(null),phone_country:f(null)};ie(()=>{var e,a,i,n;const l=C.user;if(E.value=((e=l==null?void 0:l.roles)==null?void 0:e.includes("admin"))||((a=l==null?void 0:l.roles)==null?void 0:a.includes("superadmin"))||((i=l==null?void 0:l.permissions)==null?void 0:i.includes("organization.create")),!E.value){$.replace("/403");return}l!=null&&l.organization_id&&!((n=l==null?void 0:l.roles)!=null&&n.includes("superadmin"))&&$.replace(`/organizaciones/${l.organization_id}`)});const o=H({legal_name:"",alias:"",description:"",logo:null,timezone:"",contact:{first_name:"",last_name:"",email:"",phone_country:"",phone_number:""}}),ae=M(()=>{const l=h(D.value);return l?W.filter(e=>h(e.label).includes(l)||h(e.value).includes(l)):W}),T=Y(),le=M(()=>{const l=h(B.value);return l?T.filter(e=>{const a=F(e.title),i=h(R(e.value,e.title));return a.includes(l)||i.includes(l)}):T}),w=l=>{d[l]&&(d[l]="")},P=async l=>{await xe();const e=ee[l];if(e&&e.value){const a=e.value.$el||e.value;a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),a.focus?a.focus():a.$el&&a.$el.focus&&a.$el.focus()}},S=(l,e)=>{switch(w(l),l){case"legal_name":if(!e||e.trim()==="")return d.legal_name="El nombre legal es obligatorio",!1;break;case"timezone":if(!e||e.trim()==="")return d.timezone="La zona horaria es obligatoria",!1;break;case"address":if(!b.value||Object.keys(b.value).length===0)return d.address="La dirección es obligatoria",!1;break;case"logo":break;case"phone_country":if(o.contact.phone_number&&!e)return d.phone_country="Selecciona el país para el teléfono",!1;break}return!0},te=async()=>{let l=!0,e=null;return S("legal_name",o.legal_name)||(l=!1,e||(e="legal_name")),S("timezone",o.timezone)||(l=!1,e||(e="timezone")),S("address",b.value)||(l=!1,e||(e="address")),S("phone_country",o.contact.phone_country)||(l=!1,e||(e="phone_country")),!l&&e&&await P(e),l};G(()=>o.logo,l=>{let e=null;Array.isArray(l)?e=l.length>0?l[0]:null:(l instanceof File||l instanceof Blob)&&(e=l),j.value=e?URL.createObjectURL(e):null});const oe=l=>{b.value=l,l&&Object.keys(l).length>0&&w("address")},A=f(!1);G(()=>[o.legal_name,o.timezone,b.value,o.logo,o.contact.phone_country],()=>{_.value=""});const ne=async()=>{var l,e,a,i;if(_.value="",!!await te()){A.value=!0;try{const n=new FormData;n.append("legal_name",o.legal_name),n.append("alias",o.alias||""),n.append("description",o.description||""),n.append("timezone",o.timezone);for(const m in b.value)n.append(`address[${m}]`,b.value[m]||"");if(Object.values(o.contact).some(m=>{var q;return((q=m==null?void 0:m.trim)==null?void 0:q.call(m))!==""}))for(const m in o.contact)n.append(`contact[${m}]`,o.contact[m]||"");if(o.logo){const m=Array.isArray(o.logo)?o.logo[0]:o.logo;n.append("logo",m)}const u=await ze.post("/organizations",n),g=u.data.organization||u.data.data||u.data;g!=null&&g.id&&(C.user.organization_id=g.id,await C.fetchUser(),$.replace(`/organizaciones/${g.id}`))}catch(n){if((e=(l=n==null?void 0:n.response)==null?void 0:l.data)!=null&&e.errors){const r=n.response.data.errors;let u=null;r.legal_name&&(d.legal_name=r.legal_name[0],u=u||"legal_name"),r.timezone&&(d.timezone=r.timezone[0],u=u||"timezone"),r.address&&(d.address=r.address[0],u=u||"address"),r.logo&&(d.logo=r.logo[0],u=u||"logo"),r.phone_country&&(d.phone_country=r.phone_country[0],u=u||"phone_country"),u&&await P(u);const g=Object.keys(r).filter(m=>!["legal_name","timezone","address","logo","phone_country"].includes(m));g.length>0&&(_.value=g.map(m=>r[m]).flat().join(" "))}else(i=(a=n==null?void 0:n.response)==null?void 0:a.data)!=null&&i.message?_.value=n.response.data.message:_.value="Error al crear organización";console.error("❌ Error al crear organización:",n)}finally{A.value=!1}}};return(l,e)=>E.value?(x(),I("div",Ce,[t(Ve,{fluid:""},{default:s(()=>[t(L,{class:"align-center mb-6","no-gutters":""},{default:s(()=>[t(y,{cols:"auto",class:"d-flex align-center"},{default:s(()=>{var a,i,n,r;return[(i=(a=k(C).user)==null?void 0:a.roles)!=null&&i.includes("superadmin")||(r=(n=k(C).user)==null?void 0:n.permissions)!=null&&r.includes("organization.viewAny")?(x(),N(J,{key:0,icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:e[0]||(e[0]=u=>k($).back())},{default:s(()=>[t(de,{icon:k(he)},null,8,["icon"])]),_:1})):U("",!0),e[17]||(e[17]=c("h3",{class:"font-weight-medium ml-3 mb-0"},"Agregar Organización",-1))]}),_:1})]),_:1}),t(me,{ref_key:"Regform",ref:Z,"lazy-validation":"",class:"mb-10"},{default:s(()=>[t(L,null,{default:s(()=>[t(y,{cols:"12"},{default:s(()=>[e[18]||(e[18]=c("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),t(K,{class:"mb-6"})]),_:1}),t(y,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:s(()=>[j.value?(x(),I("img",{key:0,src:j.value,alt:"Logo Preview",style:{"max-width":"300px","max-height":"300px","border-radius":"12px"}},null,8,Ae)):(x(),I("div",Ue,e[19]||(e[19]=[c("span",{style:{color:"#bbb"}},"Sin logo",-1)])))]),_:1}),t(y,{cols:"12",md:"6"},{default:s(()=>[t(v,null,{default:s(()=>e[20]||(e[20]=[p("Logo")])),_:1}),t(ce,{ref:"fieldRefs.logo",modelValue:o.logo,"onUpdate:modelValue":[e[1]||(e[1]=a=>o.logo=a),e[2]||(e[2]=a=>w("logo"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact",required:"","show-size":"",multiple:!1,"error-messages":d.logo},null,8,["modelValue","error-messages"]),t(v,null,{default:s(()=>e[21]||(e[21]=[p("Nombre Legal "),c("span",{class:"text-error"},"*",-1)])),_:1}),t(V,{ref:"fieldRefs.legal_name",modelValue:o.legal_name,"onUpdate:modelValue":[e[3]||(e[3]=a=>o.legal_name=a),e[4]||(e[4]=a=>w("legal_name"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",required:"","error-messages":d.legal_name},null,8,["modelValue","error-messages"]),t(v,null,{default:s(()=>e[22]||(e[22]=[p("Alias")])),_:1}),t(V,{modelValue:o.alias,"onUpdate:modelValue":e[5]||(e[5]=a=>o.alias=a),variant:"outlined",color:"primary",class:"mt-2 mb-4"},null,8,["modelValue"]),t(v,null,{default:s(()=>e[23]||(e[23]=[p("Descripción")])),_:1}),t(fe,{modelValue:o.description,"onUpdate:modelValue":e[6]||(e[6]=a=>o.description=a),variant:"outlined",color:"primary","auto-grow":"",rows:"3",class:"mt-2"},null,8,["modelValue"]),t(v,null,{default:s(()=>e[24]||(e[24]=[p("Zona Horaria "),c("span",{class:"text-error"},"*",-1)])),_:1}),t(Q,{ref:"fieldRefs.timezone",modelValue:o.timezone,"onUpdate:modelValue":[e[7]||(e[7]=a=>o.timezone=a),e[9]||(e[9]=a=>w("timezone"))],items:ae.value,"search-input":D.value,"onUpdate:searchInput":e[8]||(e[8]=a=>D.value=a),"item-title":"label","item-value":"value",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una zona horaria",clearable:"","hide-details":"","menu-props":{maxHeight:"400px"},required:"","error-messages":d.timezone},null,8,["modelValue","items","search-input","error-messages"])]),_:1}),t(y,{cols:"12",class:"mt-4"},{default:s(()=>[t(v,null,{default:s(()=>e[25]||(e[25]=[p("Dirección "),c("span",{class:"text-error"},"*",-1)])),_:1}),t(we,{class:"mt-2","onUpdate:parsedAddress":oe}),d.address?(x(),N(V,{key:0,ref:"fieldRefs.address","model-value":"",variant:"outlined",color:"error",class:"mt-2","error-messages":d.address,readonly:"","hide-details":""},null,8,["error-messages"])):U("",!0)]),_:1})]),_:1}),t(L,{class:"mt-10"},{default:s(()=>[t(y,{cols:"12"},{default:s(()=>[e[26]||(e[26]=c("h4",{class:"font-weight-bold mb-3"},"Contacto",-1)),t(K,{class:"mb-6"})]),_:1}),t(y,{cols:"12",sm:"6"},{default:s(()=>[t(v,null,{default:s(()=>e[27]||(e[27]=[p("Nombre")])),_:1}),t(V,{modelValue:o.contact.first_name,"onUpdate:modelValue":e[10]||(e[10]=a=>o.contact.first_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),t(y,{cols:"12",sm:"6"},{default:s(()=>[t(v,null,{default:s(()=>e[28]||(e[28]=[p("Apellido")])),_:1}),t(V,{modelValue:o.contact.last_name,"onUpdate:modelValue":e[11]||(e[11]=a=>o.contact.last_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),t(y,{cols:"12",sm:"6"},{default:s(()=>[t(v,null,{default:s(()=>e[29]||(e[29]=[p("Correo")])),_:1}),t(V,{modelValue:o.contact.email,"onUpdate:modelValue":e[12]||(e[12]=a=>o.contact.email=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),t(y,{cols:"12",sm:"6"},{default:s(()=>[t(v,null,{default:s(()=>e[30]||(e[30]=[p("Teléfono")])),_:1}),c("div",$e,[t(Q,{ref:"fieldRefs.phone_country",modelValue:o.contact.phone_country,"onUpdate:modelValue":[e[13]||(e[13]=a=>o.contact.phone_country=a),e[15]||(e[15]=a=>w("phone_country"))],items:le.value,"search-input":B.value,"onUpdate:searchInput":e[14]||(e[14]=a=>B.value=a),"item-title":"title","item-value":"value",variant:"outlined",color:"primary",class:"phone-country-field",placeholder:"País",clearable:"","hide-details":"","menu-props":{maxHeight:"400px",width:320},"error-messages":d.phone_country},{selection:s(({item:a})=>{var i;return[a&&a.value?(x(),I(ve,{key:0},[c("span",null,z((i=k(O)(a.value))==null?void 0:i.flag),1),c("span",Fe,z(R(a.value,a.title)),1)],64)):U("",!0)]}),item:s(({item:a,props:i})=>[t(pe,ge(ye(i)),{title:s(()=>{var n;return[c("div",Re,[c("span",null,[c("span",null,z((n=k(O)(a.value))==null?void 0:n.flag),1),c("span",Se,z(a.title.replace(/^.*?\s/,"")),1)]),c("span",Ie,z(R(a.value,a.title)),1)])]}),_:2},1040)]),_:1},8,["modelValue","items","search-input","error-messages"]),t(V,{modelValue:o.contact.phone_number,"onUpdate:modelValue":e[16]||(e[16]=a=>o.contact.phone_number=a),variant:"outlined",color:"primary",class:"phone-number-field",placeholder:"Número","hide-details":""},null,8,["modelValue"])])]),_:1})]),_:1}),t(L,null,{default:s(()=>[t(y,{cols:"12",class:"d-flex justify-end"},{default:s(()=>[t(J,{color:"primary",class:"mt-6",loading:A.value,disabled:A.value,onClick:ne},{loader:s(()=>[t(be,{indeterminate:"",color:"white",size:"20"})]),default:s(()=>[p(" "+z(A.value?"Creando Organización...":"Crear Organización"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),_.value?(x(),N(_e,{key:0,type:"error",class:"mt-6",variant:"outlined",density:"comfortable",style:{"max-width":"500px","margin-left":"auto"}},{default:s(()=>[p(z(_.value),1)]),_:1})):U("",!0)]),_:1},512)]),_:1})])):U("",!0)}},Oe=se(Le,[["__scopeId","data-v-23415735"]]);export{Oe as default};
