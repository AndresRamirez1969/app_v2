import{_ as ue,A as de,J as r,aC as me,ah as pe,B as A,K as P,L as f,ai as p,s as V,a as l,w as o,V as x,b as _,d as v,f as X,C as Y,a0 as ce,al as fe,aj as _e,c as ge,l as Z,H as ee,aw as c,e as d,aA as ve,U as ae,u as be,b5 as U,t as ye,aB as ie,a8 as ze,o as b}from"./index-mAfd8qbF.js";import{j as Ve}from"./mdi-CCqP_oQm.js";const xe={key:0},Ue={class:"profile-img-container"},we=["src"],he={key:1,class:"profile-img-empty"},Se={key:1},Oe={__name:"edit",setup(Re){const w=de(),D=ce(),se=me(),le=r(null),y=r(null),m=r(""),L=r(!1),B=r(""),I=r(""),$=r(""),h=r(""),T=r(""),S=r([]),O=r([]),R=r([]),k=r([]),C=r([]),q=r(!1),F=r(!1),j=r(!1),N=r(!1),E=r(!1),g=r(null),H=se.params.id,e=pe({profile_picture:null,name:"",email:"",organization_id:null,business_id:null,business_unit_id:null,role:null,contact:{first_name:"",last_name:"",email:"",phone_number:""}}),z=A(()=>{var i,a;return(a=(i=w.user)==null?void 0:i.roles)==null?void 0:a.includes("superadmin")}),ne=A(()=>{var i,a;return(a=(i=w.user)==null?void 0:i.roles)==null?void 0:a.includes("sponsor")}),G=A(()=>{var i;return(i=w.user)==null?void 0:i.organization_id}),te=async()=>{var i,a,s,u;try{const{data:t}=await f.get(`/users/${H}`),n=t.user||t.data||t;e.name=n.name||"",e.email=n.email||"",Array.isArray(n.roles)&&n.roles.length>0?e.role=n.roles[0].name:typeof n.role=="string"?e.role=n.role:n.role&&typeof n.role=="object"&&n.role.name?e.role=n.role.name:e.role="",e.organization_id=n.organization_id||null,e.business_id=n.business_id||null,e.business_unit_id=n.business_unit_id||null,e.contact.first_name=((i=n.contact)==null?void 0:i.first_name)||"",e.contact.last_name=((a=n.contact)==null?void 0:a.last_name)||"",e.contact.email=((s=n.contact)==null?void 0:s.email)||"",e.contact.phone_number=((u=n.contact)==null?void 0:u.phone_number)||"",n.profile_picture?y.value=n.profile_picture:n.profile_picture_url?y.value=n.profile_picture_url:y.value=null}catch{m.value="No se pudo cargar el usuario"}};P(async()=>{var a;const i=w.user;L.value=(a=i==null?void 0:i.permissions)==null?void 0:a.includes("user.update"),await te(),Q(),M("")});const M=async(i="")=>{q.value=!0;try{const{data:a}=await f.get("/organizations",{params:{q:i,limit:10}});S.value=(a.data||[]).map(s=>({...s,display:`${s.folio}${s.legal_name?" - "+s.legal_name:""}`}))}catch{S.value=[]}finally{q.value=!1}};p(B,i=>{M(i)});const J=async(i="")=>{F.value=!0;try{const a={q:i,limit:10};e.organization_id&&(a.organization_id=e.organization_id);const{data:s}=await f.get("/businesses",{params:a});O.value=(s.data||[]).map(u=>({...u,display:`${u.folio}${u.legal_name?" - "+u.legal_name:""}`,organization_id:u.organization_id}))}catch{O.value=[]}finally{F.value=!1}};p([I,()=>e.organization_id],([i])=>{J(i)}),P(()=>J(""));const K=async(i="")=>{j.value=!0;try{const a={q:i,limit:10};e.organization_id&&(a.organization_id=e.organization_id),e.business_id&&(a.business_id=e.business_id);const{data:s}=await f.get("/business-units",{params:a});R.value=(s.data||[]).map(u=>({...u,display:`${u.folio}${u.legal_name?" - "+u.legal_name:""}`,organization_id:u.organization_id,business_id:u.business_id}))}catch{R.value=[]}finally{j.value=!1}};p([$,()=>e.organization_id,()=>e.business_id],([i])=>{K(i)}),P(()=>K(""));const Q=async()=>{N.value=!0;try{const{data:i}=await f.get("/roles",{params:{q:h.value}});k.value=(i.data||[]).filter(a=>a.name!=="superadmin")}catch{k.value=[]}finally{N.value=!1}},W=async i=>{E.value=!0;try{const{data:a}=await f.get("/roles",{params:{organization_id:i}});C.value=(a.data||[]).filter(s=>s.name!=="superadmin")}catch{C.value=[]}finally{E.value=!1}},oe=A(()=>z.value?g.value?C.value.map(i=>({...i,display:i.name==="admin"?"Administrador":i.name==="sponsor"?"Sponsor":i.name})):[]:ne.value?k.value.filter(i=>(i.organization_id===G.value||i.name==="sponsor")&&i.name!=="admin").map(i=>({...i,display:i.name==="sponsor"?"Sponsor":i.name})):k.value.filter(i=>i.organization_id===G.value||i.name==="admin"||i.name==="sponsor").map(i=>({...i,display:i.name==="admin"?"Administrador":i.name==="sponsor"?"Sponsor":i.name})));p(h,()=>{z.value?g.value&&W(g.value):Q()}),p(g,i=>{z.value&&i&&(W(i),e.role=null)}),p(()=>e.organization_id,i=>{i&&(e.business_id=null,e.business_unit_id=null)}),p(()=>e.business_id,i=>{i&&(e.organization_id=null,e.business_unit_id=null)}),p(()=>e.business_unit_id,i=>{i&&(e.organization_id=null,e.business_id=null)});const re=async()=>{var i,a,s,u;if(m.value="",!e.name||!e.email||!e.role||!e.organization_id&&!e.business_id&&!e.business_unit_id){m.value="Por favor completa el nombre, correo, rol y selecciona organización, empresa o ubicación.";return}if(e.business_id&&!e.organization_id){const t=O.value.find(n=>n.id===e.business_id);t&&(e.organization_id=t.organization_id)}if(e.business_unit_id&&(!e.business_id||!e.organization_id)){const t=R.value.find(n=>n.id===e.business_unit_id);t&&(e.business_id=t.business_id,e.organization_id=t.organization_id)}try{const t=new FormData;if(t.append("name",e.name),t.append("email",e.email),t.append("role",e.role),e.organization_id&&t.append("organization_id",e.organization_id),e.business_id&&t.append("business_id",e.business_id),e.business_unit_id&&t.append("business_unit_id",e.business_unit_id),e.profile_picture){const n=Array.isArray(e.profile_picture)?e.profile_picture[0]:e.profile_picture;t.append("profile_picture",n)}for(const n in e.contact)e.contact[n]&&t.append(`contact[${n}]`,e.contact[n]);await f.post(`/users/${H}?_method=PUT`,t),D.replace(`/usuarios/${H}`)}catch(t){(a=(i=t==null?void 0:t.response)==null?void 0:i.data)!=null&&a.errors?m.value=Object.values(t.response.data.errors).flat().join(" "):(u=(s=t==null?void 0:t.response)==null?void 0:s.data)!=null&&u.message?m.value=t.response.data.message:m.value="Error al actualizar usuario",console.error("❌ Error al actualizar usuario:",t)}};return(i,a)=>L.value?(b(),V("div",xe,[l(ze,{fluid:""},{default:o(()=>[l(x,{class:"align-center mb-6","no-gutters":""},{default:o(()=>[l(_,{cols:"auto",class:"d-flex align-center"},{default:o(()=>[l(X,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:a[0]||(a[0]=s=>Y(D).back())},{default:o(()=>[l(fe,{icon:Y(Ve)},null,8,["icon"])]),_:1}),a[14]||(a[14]=v("h3",{class:"font-weight-medium ml-3 mb-0"},"Editar Usuario",-1))]),_:1})]),_:1}),l(_e,{ref_key:"Regform",ref:le,"lazy-validation":"",class:"mb-10"},{default:o(()=>[l(x,null,{default:o(()=>[l(_,{cols:"12"},{default:o(()=>[a[15]||(a[15]=v("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),l(ee,{class:"mb-6"})]),_:1}),l(_,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:o(()=>[v("div",Ue,[y.value?(b(),V("img",{key:0,src:y.value,alt:"Foto de perfil",class:"profile-img"},null,8,we)):(b(),V("div",he,a[16]||(a[16]=[v("span",{class:"text-medium-emphasis"},"Sin foto",-1)])))])]),_:1}),l(_,{cols:"12",md:"6"},{default:o(()=>[l(c,null,{default:o(()=>a[17]||(a[17]=[d("Foto de Perfil")])),_:1}),l(ve,{modelValue:e.profile_picture,"onUpdate:modelValue":a[1]||(a[1]=s=>e.profile_picture=s),variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact","show-size":"",multiple:!1},null,8,["modelValue"]),l(c,null,{default:o(()=>a[18]||(a[18]=[d("Nombre")])),_:1}),l(ae,{modelValue:e.name,"onUpdate:modelValue":a[2]||(a[2]=s=>e.name=s),variant:"outlined",color:"primary",class:"mt-2 mb-4",required:""},null,8,["modelValue"]),l(c,null,{default:o(()=>a[19]||(a[19]=[d("Correo")])),_:1}),l(ae,{modelValue:e.email,"onUpdate:modelValue":a[3]||(a[3]=s=>e.email=s),variant:"outlined",color:"primary",class:"mt-2 mb-4",required:""},null,8,["modelValue"]),z.value?(b(),V(be,{key:0},[l(c,null,{default:o(()=>a[20]||(a[20]=[d("Organización para filtrar roles")])),_:1}),l(U,{modelValue:g.value,"onUpdate:modelValue":a[4]||(a[4]=s=>g.value=s),items:S.value,loading:q.value,"search-input":T.value,"onUpdate:searchInput":a[5]||(a[5]=s=>T.value=s),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una organización",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},required:""},null,8,["modelValue","items","loading","search-input"])],64)):Z("",!0),a[22]||(a[22]=v("div",{style:{height:"22px"}},null,-1)),l(c,null,{default:o(()=>a[21]||(a[21]=[d("Rol")])),_:1}),l(U,{modelValue:e.role,"onUpdate:modelValue":a[6]||(a[6]=s=>e.role=s),items:oe.value,loading:z.value?E.value:N.value,"search-input":h.value,"onUpdate:searchInput":a[7]||(a[7]=s=>h.value=s),"item-title":"display","item-value":"name",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona un rol",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},required:""},null,8,["modelValue","items","loading","search-input"])]),_:1})]),_:1}),l(x,null,{default:o(()=>[l(_,{cols:"12"},{default:o(()=>[a[23]||(a[23]=v("h4",{class:"font-weight-bold mb-3"},"Pertenece a",-1)),l(ee,{class:"mb-6"})]),_:1})]),_:1}),l(x,null,{default:o(()=>[l(_,{cols:"12",md:"12"},{default:o(()=>[l(c,null,{default:o(()=>a[24]||(a[24]=[d("Organización")])),_:1}),l(U,{modelValue:e.organization_id,"onUpdate:modelValue":a[8]||(a[8]=s=>e.organization_id=s),items:S.value,loading:q.value,"search-input":B.value,"onUpdate:searchInput":a[9]||(a[9]=s=>B.value=s),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una organización",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},disabled:!!e.business_id||!!e.business_unit_id,required:!e.business_id&&!e.business_unit_id},null,8,["modelValue","items","loading","search-input","disabled","required"]),l(c,null,{default:o(()=>a[25]||(a[25]=[d("Empresa")])),_:1}),l(U,{modelValue:e.business_id,"onUpdate:modelValue":a[10]||(a[10]=s=>e.business_id=s),items:O.value,loading:F.value,"search-input":I.value,"onUpdate:searchInput":a[11]||(a[11]=s=>I.value=s),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-6",density:"compact",placeholder:"Selecciona una empresa",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},disabled:!!e.organization_id||!!e.business_unit_id,required:!e.organization_id&&!e.business_unit_id},null,8,["modelValue","items","loading","search-input","disabled","required"]),l(c,null,{default:o(()=>a[26]||(a[26]=[d("Ubicación")])),_:1}),l(U,{modelValue:e.business_unit_id,"onUpdate:modelValue":a[12]||(a[12]=s=>e.business_unit_id=s),items:R.value,loading:j.value,"search-input":$.value,"onUpdate:searchInput":a[13]||(a[13]=s=>$.value=s),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",density:"compact",placeholder:"Selecciona una ubicación",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},disabled:!!e.organization_id||!!e.business_id,required:!e.organization_id&&!e.business_id},null,8,["modelValue","items","loading","search-input","disabled","required"])]),_:1})]),_:1}),l(x,null,{default:o(()=>[l(_,{cols:"12",class:"d-flex justify-end"},{default:o(()=>[l(X,{color:"primary",class:"mt-6",onClick:re},{default:o(()=>a[27]||(a[27]=[d("Guardar cambios")])),_:1})]),_:1})]),_:1}),m.value?(b(),ge(ie,{key:0,type:"error",class:"mt-6",variant:"outlined",density:"comfortable",style:{"max-width":"500px","margin-left":"auto"}},{default:o(()=>[d(ye(m.value),1)]),_:1})):Z("",!0)]),_:1},512)]),_:1})])):(b(),V("div",Se,[l(ie,{type:"error",class:"mt-10",variant:"outlined",density:"comfortable"},{default:o(()=>a[28]||(a[28]=[d(" No tienes permiso para editar usuarios. ")])),_:1})]))}},Ae=ue(Oe,[["__scopeId","data-v-4c156ea9"]]);export{Ae as default};
