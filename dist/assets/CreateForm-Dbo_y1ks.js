import{A as me,ak as ve,B as R,ah as pe,J as r,ai as Y,K as ce,L as F,c as _,w as t,a as l,j as fe,f as se,al as ge,C as le,av as be,b as V,aj as ye,l as z,d as u,V as w,aw as f,e as c,U as H,ax as oe,at as x,ay as _e,az as D,aA as Ve,aB as W,t as te,aq as we,a8 as Ue,a0 as Se,o as U}from"./index-DA8Oyi7H.js";import{F as ze,u as Ae}from"./constants-nBv8b9vA.js";import{j as $e}from"./mdi-CCqP_oQm.js";const ie=X=>{const A={};return X.forEach(i=>{var L;const g=(L=i==null?void 0:i.roles)==null?void 0:L[0];g&&(A[g.id]||(A[g.id]={id:g.id,name:g.name,users:[],customLabel:g.name}),A[g.id].users.push(i))}),Object.values(A)},xe={class:"mb-6"},Fe={class:"mb-6"},Le={class:"mb-6"},ke={class:"mb-6"},qe={class:"mb-6"},Ce={class:"mb-6"},Re={class:"mb-6"},Be={class:"mb-6"},Ee={class:"mb-6"},Ie={class:"mb-6"},De={__name:"CreateForm",setup(X){const A=me(),i=A.user,g=ve(),L=Se(),ue=()=>{L.push("/formularios")},G=R(()=>{var a;return(a=i==null?void 0:i.permissions)==null?void 0:a.includes("business.viewAny")});R(()=>{var a;return(a=i==null?void 0:i.permissions)==null?void 0:a.includes("business_unit.viewAny")});const B=R(()=>i==null?void 0:i.business_id),p=pe({name:"",description:"",supervisor:"",auditors:"",audited:"",frequency:"",scope:""}),ne=r(""),O=r(""),P=r(""),M=r(""),E=r([]),$=r([]),J=r(""),S=r(""),d=r(""),o=r(""),I=r(!1),k=r([]),K=r([]),Z=r([]),y=r(""),N=r(null),q=r(!1),T=r([]),Q=r([]),j=R(()=>ie(Q.value)),h=R(()=>ie(T.value)),re=async()=>{try{const a=await F.get("/users");Q.value=a.data.data.map(e=>{var s,m;return{...e,customLabel:`${((m=(s=e.roles)==null?void 0:s[0])==null?void 0:m.name)||"Sin rol"}`}}),console.log(a.data.data)}catch(a){console.error("Error fetching users:",a),Q.value=[]}},ee=async()=>{var a;try{if(o.value==="business_unit_group"&&!y.value||o.value==="business"&&!d.value||o.value==="business_unit"&&!S.value)return;const e={scope:o.value};o.value==="business"&&d.value?e.business_id=d.value:o.value==="business_unit"&&S.value?e.business_unit_id=S.value:o.value==="organization"?e.organization_id=(a=A.user)==null?void 0:a.organization_id:o.value==="business_unit_group"&&y.value&&(e.business_unit_group_id=y.value);const s=await F.get("/users-by-scope",{params:e});if(T.value=s.data.data.map(m=>{var n,v;return{...m,customLabel:`${((v=(n=m.roles)==null?void 0:n[0])==null?void 0:v.name)||"Sin rol"}`}}),o.value==="business_unit_group"&&y.value){const m=new Set;T.value.forEach(n=>{n.roles&&n.roles.length>0&&n.roles.forEach(v=>{m.add(v.id)})}),$.value=Array.from(m)}}catch(e){console.error("Error fetching users:",e),T.value=[]}};Y([o,d,S,y],async()=>{o.value&&(o.value!=="business_unit_group"&&($.value=[]),E.value=[],(o.value==="business"||o.value==="business_unit")&&B.value&&!G.value&&(d.value=B.value,o.value==="business_unit"&&await ae()),await ee())}),Y(d,async a=>{a&&o.value==="business_unit"&&(S.value="",await ae())}),Y(y,async a=>{o.value==="business_unit_group"&&a&&await ee()});const ae=async(a="")=>{try{const e={q:a,limit:10};if(o.value==="business_unit"){const s=await F.get("/business-units",{params:e});K.value=s.data.data.map(m=>({...m,customLabel:`${m.legal_name}`}))}}catch(e){console.log(e),K.value=[]}};ce(async()=>{try{await re();const a=await F.get("/businesses");console.log(a.data.data),k.value=a.data.data.map(s=>({...s,customLabel:`${s.legal_name}`}));const e=await F.get("/business-unit-groups");Z.value=e.data.data.map(s=>({...s,customLabel:`${s.name}`}))}catch(a){console.log(a)}});const b=a=>{p[a]&&(p[a]="")},C=r(!1),de=async()=>{try{C.value=!0;const a=new FormData;a.append("name",O.value),a.append("description",P.value);const e=j.value.find(n=>n.id===M.value);if(e&&a.append("supervisor_role_id",e.id),E.value.forEach((n,v)=>{a.append(`auditor_role_ids[${v}]`,n)}),$.value.forEach((n,v)=>{a.append(`auditado_role_ids[${v}]`,n)}),a.append("frequency",J.value),a.append("assignment_scope",o.value),a.append("has_rating",I.value?"1":"0"),console.log(I.value),N.value&&!q.value&&a.append("logo",N.value),q.value&&o.value!=="organization"){let n=null;if(o.value==="business"&&d.value?n=k.value.find(v=>v.id===d.value):o.value==="business_unit"&&d.value?n=k.value.find(v=>v.id===d.value):o.value==="business_unit_group"&&d.value&&(n=k.value.find(v=>v.id===d.value)),n!=null&&n.logo){const v=await Ae(n.logo,n.legal_name);a.append("logo",v)}}o.value==="organization"?a.append("organization_id",i==null?void 0:i.organization_id):o.value==="business"?(a.append("business_id",d.value),a.append("organization_id",i==null?void 0:i.organization_id)):o.value==="business_unit"?(a.append("business_id",d.value),a.append("business_unit_id",S.value),a.append("organization_id",i==null?void 0:i.organization_id)):o.value==="business_unit_group"&&(a.append("business_unit_group_id",y.value),a.append("organization_id",i==null?void 0:i.organization_id),a.append("business_id",d.value));const s=await F.post("/forms",a,{headers:{"Content-Type":"multipart/form-data"}});g.success("Formulario creado correctamente");const m=s.data.form;m&&m.id&&L.push({name:"AddFieldsForm",params:{id:m.id},state:{form:m}})}catch{g.error("Error al crear el formulario")}finally{C.value=!1}};return(a,e)=>(U(),_(Ue,{fluid:""},{default:t(()=>[l(be,{class:"mb-4",density:"compact",title:"Creacion de Formulario"},fe({_:2},[a.isSponsor?void 0:{name:"prepend",fn:t(()=>[l(se,{icon:"",onClick:ue},{default:t(()=>[l(ge,{icon:le($e)},null,8,["icon"])]),_:1})]),key:"0"}]),1024),l(w,null,{default:t(()=>[l(V,{cols:"12",md:"12"},{default:t(()=>[l(ye,{ref_key:"Regform",ref:ne,"lazy-validation":"",action:"/dashboards/analytical",class:"container mt-5"},{default:t(()=>[l(w,{class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0"},{default:t(()=>[u("div",xe,[l(f,null,{default:t(()=>e[24]||(e[24]=[c("Nombre del Formulario "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(H,{modelValue:O.value,"onUpdate:modelValue":[e[0]||(e[0]=s=>O.value=s),e[1]||(e[1]=s=>b("name"))],required:"",variant:"outlined",class:"mt-2",color:"primary","error-messages":p.name},null,8,["modelValue","error-messages"])])]),_:1}),l(oe,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=s=>I.value=s),label:"Preguntas con ponderación?",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),l(w,{class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0"},{default:t(()=>[u("div",Fe,[l(f,null,{default:t(()=>e[25]||(e[25]=[c("Descripción")])),_:1}),l(H,{modelValue:P.value,"onUpdate:modelValue":[e[3]||(e[3]=s=>P.value=s),e[4]||(e[4]=s=>b("description"))],variant:"outlined",class:"mt-2",color:"primary","error-messages":p.description},null,8,["modelValue","error-messages"])])]),_:1})]),_:1}),l(w,{class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0"},{default:t(()=>[u("div",Le,[l(f,null,{default:t(()=>e[26]||(e[26]=[c("Supervisor "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(x,{modelValue:M.value,"onUpdate:modelValue":[e[5]||(e[5]=s=>M.value=s),e[6]||(e[6]=s=>b("supervisor"))],items:j.value,"item-title":"customLabel","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",label:"Selecciona al Supervisor","error-messages":p.supervisor},null,8,["modelValue","items","error-messages"])])]),_:1})]),_:1}),l(w,{class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0 d-flex flex-column justify-center"},{default:t(()=>[l(f,{class:"mb2"},{default:t(()=>e[27]||(e[27]=[c("Alcance "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(_e,{modelValue:o.value,"onUpdate:modelValue":e[7]||(e[7]=s=>o.value=s),inline:""},{default:t(()=>[l(D,{label:"Organizacional",value:"organization"}),l(D,{label:"Por Negocio",value:"business"}),l(D,{label:"Por Unidad",value:"business_unit"}),l(D,{label:"Asignar a Grupo",value:"business_unit_group"})]),_:1},8,["modelValue"]),p.scope?(U(),_(H,{key:0,"model-value":"",variant:"outlined",color:"error",class:"mt-2","error-messages":p.scope,readonly:"","hide-details":""},null,8,["error-messages"])):z("",!0)]),_:1})]),_:1}),l(w,{class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0"},{default:t(()=>[u("div",ke,[l(f,null,{default:t(()=>e[28]||(e[28]=[c("Logo "),u("span",{class:"text-error"},"*",-1)])),_:1}),q.value?z("",!0):(U(),_(Ve,{key:0,modelValue:N.value,"onUpdate:modelValue":[e[8]||(e[8]=s=>N.value=s),e[9]||(e[9]=s=>b("logo"))],label:"Logo",multiple:!1,variant:"outlined",color:"primary",class:"mt-2",accept:"image/*","error-messages":p.logo},null,8,["modelValue","error-messages"])),o.value&&o.value!=="organization"?(U(),_(oe,{key:1,modelValue:q.value,"onUpdate:modelValue":e[10]||(e[10]=s=>q.value=s),label:"Mismo logo que Negocio",color:"primary",class:"mt-2"},null,8,["modelValue"])):z("",!0)])]),_:1})]),_:1}),o.value==="business"||o.value==="business_unit"?(U(),_(w,{key:0,class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0"},{default:t(()=>[u("div",qe,[l(f,null,{default:t(()=>e[29]||(e[29]=[c("Negocio "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(x,{modelValue:d.value,"onUpdate:modelValue":[e[11]||(e[11]=s=>d.value=s),e[12]||(e[12]=s=>b("businessId"))],items:k.value,"item-title":"customLabel","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",label:"Selecciona el Negocio",required:"",disabled:B.value&&!G.value,"error-messages":p.businessId},null,8,["modelValue","items","disabled","error-messages"]),B.value&&!G.value?(U(),_(W,{key:0,type:"info",variant:"tonal",class:"mt-2",density:"compact"},{default:t(()=>e[30]||(e[30]=[u("strong",null,"Asignación automática de negocio",-1)])),_:1})):z("",!0)])]),_:1})]),_:1})):z("",!0),o.value==="business_unit"?(U(),_(w,{key:1,class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0"},{default:t(()=>[u("div",Ce,[l(f,null,{default:t(()=>e[31]||(e[31]=[c("Unidad de Negocio "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(x,{modelValue:S.value,"onUpdate:modelValue":[e[13]||(e[13]=s=>S.value=s),e[14]||(e[14]=s=>b("businessUnitId"))],items:K.value,"item-title":"customLabel","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",label:"Selecciona la Unidad de Negocio",required:"","error-messages":p.businessUnitId},null,8,["modelValue","items","error-messages"])])]),_:1})]),_:1})):z("",!0),o.value==="business_unit_group"?(U(),_(w,{key:2,class:"my-0"},{default:t(()=>[l(V,{cols:"12",sm:"6",class:"py-0"},{default:t(()=>[u("div",Re,[l(f,null,{default:t(()=>e[32]||(e[32]=[c("Grupo "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(x,{modelValue:y.value,"onUpdate:modelValue":[e[15]||(e[15]=s=>y.value=s),e[16]||(e[16]=s=>b("groupId"))],items:Z.value,"item-title":"customLabel","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",label:"Selecciona el Grupo",required:"","error-messages":p.groupId},null,8,["modelValue","items","error-messages"]),l(W,{type:"info",variant:"tonal",class:"mt-2",density:"compact"},{default:t(()=>e[33]||(e[33]=[u("strong",null,"Asignación automática:",-1),c(" Al seleccionar un grupo, se asignarán automáticamente TODOS los roles de las unidades de negocio que pertenecen a este grupo como auditados. ")])),_:1})])]),_:1})]),_:1})):z("",!0),u("div",Be,[l(f,null,{default:t(()=>e[34]||(e[34]=[c("Auditores "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(x,{modelValue:E.value,"onUpdate:modelValue":[e[17]||(e[17]=s=>E.value=s),e[18]||(e[18]=s=>b("auditors"))],items:j.value,multiple:"","item-title":"customLabel","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",label:"Selecciona a los Auditores",hint:`${j.value.length} roles disponibles`,"persistent-hint":"","error-messages":p.auditors},null,8,["modelValue","items","hint","error-messages"])]),u("div",Ee,[l(f,null,{default:t(()=>e[35]||(e[35]=[c("Auditados "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(x,{modelValue:$.value,"onUpdate:modelValue":[e[19]||(e[19]=s=>$.value=s),e[20]||(e[20]=s=>b("audited"))],multiple:"",items:h.value,"item-title":"customLabel","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",label:"Selecciona a los Auditados",hint:o.value==="business_unit_group"?"Selección automática para grupos":`${h.value.length} roles disponibles`,"persistent-hint":"",disabled:o.value==="business_unit_group",readonly:o.value==="business_unit_group","error-messages":p.audited},null,8,["modelValue","items","hint","disabled","readonly","error-messages"]),o.value==="business_unit_group"&&$.value.length>0?(U(),_(W,{key:0,type:"success",variant:"tonal",class:"mt-2",density:"compact"},{default:t(()=>[c(" Se han asignado automáticamente "+te($.value.length)+" roles de las unidades del grupo seleccionado. ",1)]),_:1})):z("",!0)]),u("div",Ie,[l(f,null,{default:t(()=>e[36]||(e[36]=[c("Frecuencia "),u("span",{class:"text-error"},"*",-1)])),_:1}),l(x,{modelValue:J.value,"onUpdate:modelValue":[e[21]||(e[21]=s=>J.value=s),e[22]||(e[22]=s=>b("frequency"))],items:le(ze),"item-title":"label","item-value":"value",variant:"outlined",color:"primary",class:"mt-2",label:"Selecciona la frecuencia del formulario",required:"","error-messages":p.frequency},null,8,["modelValue","items","error-messages"])]),e[37]||(e[37]=u("div",{class:"d-sm-inline-flex align-center mt-2 mb-7 mb-sm-0 font-weight-bold"},null,-1)),l(se,{color:"primary",block:"",class:"mt-4",variant:"flat",size:"large",loading:C.value,disabled:C.value,onClick:e[23]||(e[23]=s=>de())},{loader:t(()=>[l(we,{indeterminate:"",color:"white",size:"20"})]),default:t(()=>[c(" "+te(C.value?"Creando Formulario...":"Crear Formulario"),1)]),_:1},8,["loading","disabled"])]),_:1},512)]),_:1})]),_:1})]),_:1}))}};export{De as default};
