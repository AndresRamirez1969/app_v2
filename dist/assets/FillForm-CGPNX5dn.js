import{_ as O,J as v,s as l,o as r,d as _,a as o,w as n,e as b,f as D,C as F,b2 as M,ak as G,aC as H,K,c as A,b as W,a0 as Y,al as B,t as x,V as Q,ag as X,aq as Z,l as q,H as I,aj as ee,a2 as ae,u as U,v as j,ab as te,a8 as se,L,aw as N,aA as oe,b1 as re,ay as le,az as ne,r as ie,x as ue}from"./index-mAfd8qbF.js";import{j as ce,a as de}from"./mdi-CCqP_oQm.js";import{b as me,g as pe}from"./constants-nBv8b9vA.js";const ve=i=>i==null?"":typeof i=="boolean"?i?"true":"false":typeof i=="number"?i.toString():typeof i=="object"?JSON.stringify(i):Array.isArray(i)?i.join(","):i instanceof File?i.name:String(i),ge={class:"d-flex gap-2 mb-3"},ye={__name:"SignaturePad",emits:["signature-changed"],setup(i,{expose:C,emit:E}){const h=v(null),w=()=>{h.value.undoSignature()},t=()=>{h.value.clearSignature(),g("signature-changed",null)},m=()=>{if(h.value){const{isEmpty:k,data:p}=h.value.saveSignature();if(k)console.log("Firma vacía");else{const u=p.split(",")[1],S=atob(u),z=new Array(S.length);for(let V=0;V<S.length;V++)z[V]=S.charCodeAt(V);const P=new Uint8Array(z),T=new Blob([P],{type:"image/png"});g("signature-changed",T)}}};C({save:m,undo:w,clear:t});const g=E;return(k,p)=>(r(),l("div",null,[_("div",ge,[o(D,{onClick:m,color:"primary",variant:"outlined",size:"small",class:"mr-2"},{default:n(()=>p[0]||(p[0]=[b(" Guardar ")])),_:1}),o(D,{onClick:w,color:"secondary",variant:"outlined",size:"small"},{default:n(()=>p[1]||(p[1]=[b(" Deshacer ")])),_:1}),o(D,{onClick:t,color:"error",variant:"outlined",size:"small"},{default:n(()=>p[2]||(p[2]=[b(" Borrar ")])),_:1})]),o(F(M),{width:"500px",height:"500px",ref_key:"signaturePad",ref:h,options:{penColor:"black",backgroundColor:"white"}},null,512)]))}},fe=O(ye,[["__scopeId","data-v-b11a8e2b"]]),_e={class:"font-weight-medium ml-3 mb-0"},be={key:0,class:"text-center pa-8"},he={key:1},ke={class:"mb-6"},xe={key:0,class:"text-body-1 text-grey-darken-1 mb-4"},Ve={key:0},Fe={key:0,class:"text-caption text-grey"},Ce={key:1},we={class:"checkbox-group"},Se={key:0,class:"text-caption text-red mt-1"},qe={key:2},De={class:"signature-container"},Ee={key:0,class:"text-caption text-green mt-1"},ze={key:3},Ae={class:"d-flex justify-end mt-6"},Ne={key:2,class:"text-center pa-8"},Pe={__name:"FillForm",setup(i){const C=G(),E=Y(),h=H(),w=v(h.params.id),t=v({}),m=v({}),g=v({}),k=v(!1),p=v(!1),u=v(null),S=v(null),z=v({}),P=async()=>{k.value=!0;try{const c=await L.get(`/forms/${w.value}`);u.value=c.data,u.value&&u.value.fields&&u.value.fields.forEach(s=>{s.type==="checkbox"?t.value[s.id]=[]:s.type==="file"?(t.value[s.id]=null,m.value[s.id]=null):s.type==="signature"?(t.value[s.id]=null,g.value[s.id]=null):t.value[s.id]=""})}catch(c){console.error("Failed to fetch form",c)}finally{k.value=!1}};K(()=>{P()});const T=(c,s)=>{const e=s.target.files[0];e&&(m.value[c]=e,t.value[c]=e.name)},V=(c,s)=>{if(s instanceof Blob){const e=u.value.fields.find(a=>a.id==c),y=`firma_${(e==null?void 0:e.label)||c}.png`,f=new File([s],y,{type:"image/*",lastModified:Date.now()});g.value[c]=f,t.value[c]=y,console.log("Firma guardada como archivo completo:",{fileName:y,fileType:f.type,fileSize:f.size})}else g.value[c]=null,t.value[c]=null},R=async()=>{if(u.value.fields.filter(e=>e.is_required).filter(e=>e.type==="checkbox"?!t.value[e.id]||t.value[e.id].length===0:(e.type==="signature",!t.value[e.id])).length>0){C.error("Por favor completa todos los campos requeridos");return}p.value=!0;try{const e=new FormData,y=Object.keys(t.value).map(a=>{const d=u.value.fields.find(J=>J.id==a),$={form_field_id:a,value:d.type==="file"||d.type==="signature"?t.value[a]:ve(t.value[a])};return(d.type==="file"||d.type==="signature")&&($.is_file=!0),$});e.append("answers",JSON.stringify(y)),Object.keys(m.value).forEach(a=>{m.value[a]&&e.append(`file_${a}`,m.value[a])}),Object.keys(g.value).forEach(a=>{g.value[a]&&e.append(`file_${a}`,g.value[a])});for(let[a,d]of e.entries())d instanceof File?console.log("Archivo en FormData:",{key:a,fileName:d.name,fileType:d.type,fileSize:d.size,isImage:d.type.startsWith("image/")}):console.log("Otro dato en FormData:",a,d);const f=await L.post(`/forms/${w.value}/responses`,e,{headers:{"Content-Type":"multipart/form-data"}});console.log(f.data),C.success("Formulario enviado correctamente"),E.push("/mis-formularios")}catch(e){console.error("Failed to submit form",e),C.error("Error al enviar el formulario")}finally{p.value=!1}};return(c,s)=>(r(),A(se,{fluid:""},{default:n(()=>[o(Q,{class:"align-center mb-6","no-gutters":""},{default:n(()=>[o(W,{cols:"auto",class:"d-flex align-center"},{default:n(()=>{var e;return[o(D,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:s[0]||(s[0]=y=>F(E).back())},{default:n(()=>[o(B,{icon:F(ce)},null,8,["icon"])]),_:1}),_("h3",_e,x(((e=u.value)==null?void 0:e.name)||"Formulario"),1)]}),_:1})]),_:1}),o(te,null,{default:n(()=>[o(X,null,{default:n(()=>[k.value?(r(),l("div",be,[o(Z,{indeterminate:"",color:"primary",size:"64"}),s[1]||(s[1]=_("p",{class:"mt-4"},"Cargando formulario...",-1))])):u.value&&u.value.fields?(r(),l("div",he,[_("div",ke,[u.value.description?(r(),l("p",xe,x(u.value.description),1)):q("",!0),o(I,{class:"mb-4"})]),o(ee,{ref_key:"formRef",ref:S,onSubmit:ae(R,["prevent"])},{default:n(()=>[(r(!0),l(U,null,j(u.value.fields,(e,y)=>{var f;return r(),l("div",{key:e.id||y,class:"mb-6"},[e.type==="file"?(r(),l("div",Ve,[o(N,{class:"mb-2"},{default:n(()=>[b(x(e.label),1)]),_:2},1024),o(oe,{modelValue:m.value[e.id],"onUpdate:modelValue":a=>m.value[e.id]=a,accept:"image/*",label:"Seleccionar imagen",rules:e.is_required?[a=>!!a||"Este campo es requerido"]:[],onChange:a=>T(e.id,a),variant:"outlined"},null,8,["modelValue","onUpdate:modelValue","rules","onChange"]),m.value[e.id]?(r(),l("div",Fe,"Archivo seleccionado: "+x(m.value[e.id].name),1)):q("",!0)])):e.type==="checkbox"?(r(),l("div",Ce,[o(N,{class:"mb-2"},{default:n(()=>[b(x(e.label),1)]),_:2},1024),_("div",we,[(r(!0),l(U,null,j(e.options,a=>(r(),A(re,{key:a,label:a,value:a,modelValue:t.value[e.id],"onUpdate:modelValue":d=>t.value[e.id]=d,class:"ml-4"},null,8,["label","value","modelValue","onUpdate:modelValue"]))),128))]),e.is_required&&!((f=t.value[e.id])!=null&&f.length)?(r(),l("div",Se," Este campo es requerido ")):q("",!0)])):e.type==="signature"?(r(),l("div",qe,[o(N,{class:"mb-2"},{default:n(()=>[b(x(e.label),1)]),_:2},1024),_("div",De,[o(fe,{ref_for:!0,ref:a=>{a&&(z.value[e.id]=a)},onSignatureChanged:a=>V(e.id,a)},null,8,["onSignatureChanged"])]),t.value[e.id]?(r(),l("div",Ee,"✓ Firma guardada")):q("",!0)])):e.type==="radio"?(r(),l("div",ze,[o(N,{class:"mb-2"},{default:n(()=>[b(x(e.label),1)]),_:2},1024),o(le,{modelValue:t.value[e.id],"onUpdate:modelValue":a=>t.value[e.id]=a,rules:e.is_required?[a=>!!a||"Este campo es requerido"]:[]},{default:n(()=>[(r(!0),l(U,null,j(e.options,a=>(r(),A(ne,{key:a,label:a,value:a,class:"ml-4"},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","rules"])])):e.type!=="file"&&e.type!=="checkbox"&&e.type!=="radio"?(r(),A(ie(F(me)(e)),ue({key:4,ref_for:!0},F(pe)(e),{modelValue:t.value[e.id],"onUpdate:modelValue":a=>t.value[e.id]=a,rules:e.is_required?[a=>!!a||"Este campo es requerido"]:[]}),null,16,["modelValue","onUpdate:modelValue","rules"])):q("",!0)])}),128))]),_:1},512),_("div",Ae,[o(D,{color:"primary",variant:"flat",onClick:R,loading:p.value,disabled:k.value,size:"large"},{default:n(()=>[o(B,{icon:F(de),class:"mr-2"},null,8,["icon"]),s[2]||(s[2]=b(" Enviar Formulario "))]),_:1},8,["loading","disabled"])])])):(r(),l("div",Ne,s[3]||(s[3]=[_("p",{class:"text-grey"},"No se pudo cargar el formulario o no tiene campos",-1)])))]),_:1})]),_:1})]),_:1}))}},Re=O(Pe,[["__scopeId","data-v-66e2ce3e"]]);export{Re as default};
