import{_ as fe,A as ce,J as f,af as Q,an as ge,Z as ye,am as W,B as K,ag as ve,s as R,l as F,a as s,w as o,V as D,b,d as c,f as X,C as E,aj as be,ah as Ve,c as Y,H as ee,aw as V,e as y,aA as xe,u as ae,at as ze,R as z,b4 as we,b5 as le,p as _e,b6 as he,b7 as ke,t as w,aq as Ce,aB as Ae,a6 as Ue,b8 as $e,o as _}from"./index-BtdFDd_C.js";import{j as Se}from"./mdi-CCqP_oQm.js";import{t as se,A as Re}from"./timezones--4UnaJtk.js";import{f as H,t as Fe}from"./countries-Ba2Yp21G.js";const Ee={key:0},Ie=["src"],je={key:1,style:{width:"300px",height:"300px",display:"flex","align-items":"center","justify-content":"center",background:"#f5f5f5","border-radius":"12px"}},Le={class:"phone-group mt-2"},Be={style:{"margin-left":"6px"}},De={class:"d-flex align-center justify-space-between"},Pe={style:{"margin-left":"8px"}},Ne={class:"text-medium-emphasis"},Te={__name:"create",setup(Oe){const U=ce(),P=ye(),te=f(null),h=f({}),N=f(null),x=f(""),M=f(!1),T=f(""),O=f(""),q=f([]),I=f(null);function k(a){return a?a.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function j(a=""){return k(String(a).replace(/\s*\(\+\d+\)\s*$/,"").trim())}function L(a,e=""){const l=H(a),r=(l==null?void 0:l.dial_code)??(l==null?void 0:l.calling_code)??(l==null?void 0:l.callingCode)??(l==null?void 0:l.phoneCode)??null;if(r)return String(r).startsWith("+")?r:`+${r}`;const n=String(e).match(/\(\+[\d]+\)/);return n&&n[0]?n[0].replace(/[()]/g,""):""}function oe(a,e){const l=r=>{const n=L(r.value,r.title);let d=0;return n&&(d+=2),r.value&&(d+=1),String(r.value||"").length<=3&&(d+=1),d};return l(a)>=l(e)?a:e}function ne(){const a=Fe(),e=new Set,l=a.filter(d=>e.has(d.value)?!1:(e.add(d.value),!0)),r=new Map;for(const d of l){const i=j(d.title),u=r.get(i);u?r.set(i,oe(u,d)):r.set(i,d)}const n=Array.from(r.values()).map(d=>({...d,title:d.title.replace(/\s*\(\+\d+\)\s*$/,"").trim()}));return n.sort((d,i)=>j(d.title).localeCompare(j(i.title))),n}const p=Q({name:"",timezone:"",address:"",logo:"",phone_country:""}),re={name:f(null),timezone:f(null),address:f(null),logo:f(null),phone_country:f(null)};ge(async()=>{var e,l,r,n,d,i,u;const a=U.user;if(M.value=((e=a==null?void 0:a.roles)==null?void 0:e.includes("admin"))||((l=a==null?void 0:a.roles)==null?void 0:l.includes("superadmin"))||((r=a==null?void 0:a.permissions)==null?void 0:r.includes("business.create")),a!=null&&a.business_id&&!((n=a==null?void 0:a.roles)!=null&&n.includes("superadmin"))&&!((d=a==null?void 0:a.roles)!=null&&d.includes("admin"))&&!((i=a==null?void 0:a.permissions)!=null&&i.includes("business.viewAny"))&&P.replace(`/empresas/${a.business_id}`),(u=a==null?void 0:a.roles)!=null&&u.includes("superadmin"))try{const m=await W.get("/organizations"),$=Array.isArray(m.data)?m.data:m.data.data;q.value=$.map(v=>({...v,display:`${v.folio||""} - ${v.legal_name||""}`.trim()}))}catch{q.value=[]}});const t=Q({name:"",alias:"",description:"",timezone:"",logo:null,person:{first_name:"",last_name:"",email:"",phone_country:"",phone_number:""}}),ie=K(()=>{const a=k(T.value);return a?se.filter(e=>k(e.label).includes(a)||k(e.value).includes(a)):se}),Z=ne(),ue=K(()=>{const a=k(O.value);return a?Z.filter(e=>{const l=j(e.title),r=k(L(e.value,e.title));return l.includes(a)||r.includes(a)}):Z}),C=a=>{p[a]&&(p[a]="")},G=async a=>{await $e();const e=re[a];if(e&&e.value){const l=e.value.$el||e.value;l.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),l.focus?l.focus():l.$el&&l.$el.focus&&l.$el.focus()}},B=(a,e)=>{switch(C(a),a){case"name":if(!e||e.trim()==="")return p.name="El nombre es obligatorio",!1;break;case"timezone":if(!e||e.trim()==="")return p.timezone="La zona horaria es obligatoria",!1;break;case"address":if(!h.value||Object.keys(h.value).length===0)return p.address="La dirección es obligatoria",!1;break;case"logo":break;case"phone_country":if(t.person.phone_number&&!e)return p.phone_country="Selecciona el país para el teléfono",!1;break}return!0},de=async()=>{let a=!0,e=null;return B("name",t.name)||(a=!1,e||(e="name")),B("timezone",t.timezone)||(a=!1,e||(e="timezone")),B("address",h.value)||(a=!1,e||(e="address")),B("phone_country",t.person.phone_country)||(a=!1,e||(e="phone_country")),!a&&e&&await G(e),a};ve(()=>t.logo,a=>{let e=null;Array.isArray(a)?e=a.length>0?a[0]:null:(a instanceof File||a instanceof Blob)&&(e=a),N.value=e?URL.createObjectURL(e):null});const me=a=>{h.value=a,a&&Object.keys(a).length>0&&C("address")},A=f(!1),pe=async()=>{var a,e,l,r,n,d;if(x.value="",!!await de()){A.value=!0;try{const i=new FormData;i.append("name",t.name),i.append("alias",t.alias||""),i.append("description",t.description||""),i.append("timezone",t.timezone);const u=U.user;let m=null;if((a=u==null?void 0:u.roles)!=null&&a.includes("superadmin")){if(!I.value){x.value="Selecciona una organización.",A.value=!1;return}m=I.value}else(e=u==null?void 0:u.permissions)!=null&&e.includes("business.create")&&(m=u.organization_id);m&&i.append("organization_id",m);for(const g in h.value)i.append(`address[${g}]`,h.value[g]||"");if(Object.values(t.person).some(g=>{var J;return((J=g==null?void 0:g.trim)==null?void 0:J.call(g))!==""}))for(const g in t.person)i.append(`person[${g}]`,t.person[g]||"");if(t.logo){const g=Array.isArray(t.logo)?t.logo[0]:t.logo;i.append("logo",g)}const v=await W.post("/businesses",i),S=v.data.business||v.data.data||v.data;S!=null&&S.id&&(U.user.business_id=S.id,await U.fetchUser(),P.replace(`/empresas/${S.id}`))}catch(i){if((r=(l=i==null?void 0:i.response)==null?void 0:l.data)!=null&&r.errors){const u=i.response.data.errors;let m=null;u.name&&(p.name=u.name[0],m=m||"name"),u.timezone&&(p.timezone=u.timezone[0],m=m||"timezone"),u.address&&(p.address=u.address[0],m=m||"address"),u.logo&&(p.logo=u.logo[0],m=m||"logo"),u.phone_country&&(p.phone_country=u.phone_country[0],m=m||"phone_country"),m&&await G(m);const $=Object.keys(u).filter(v=>!["name","timezone","address","logo","phone_country"].includes(v));$.length>0&&(x.value=$.map(v=>u[v]).flat().join(" "))}else(d=(n=i==null?void 0:i.response)==null?void 0:n.data)!=null&&d.message?x.value=i.response.data.message:x.value="Error al crear empresa";console.error("❌ Error al crear empresa:",i)}finally{A.value=!1}}};return(a,e)=>M.value?(_(),R("div",Ee,[s(Ue,{fluid:""},{default:o(()=>[s(D,{class:"align-center mb-6","no-gutters":""},{default:o(()=>[s(b,{cols:"auto",class:"d-flex align-center"},{default:o(()=>[s(X,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:e[0]||(e[0]=l=>E(P).back())},{default:o(()=>[s(be,{icon:E(Se)},null,8,["icon"])]),_:1}),e[18]||(e[18]=c("h3",{class:"font-weight-medium ml-3 mb-0"},"Agregar Empresa",-1))]),_:1})]),_:1}),s(Ve,{ref_key:"Regform",ref:te,"lazy-validation":"",class:"mb-10"},{default:o(()=>[s(D,null,{default:o(()=>[s(b,{cols:"12"},{default:o(()=>[e[19]||(e[19]=c("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),s(ee,{class:"mb-6"})]),_:1}),s(b,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:o(()=>[N.value?(_(),R("img",{key:0,src:N.value,alt:"Logo Preview",style:{"max-width":"300px","max-height":"300px","border-radius":"12px"}},null,8,Ie)):(_(),R("div",je,e[20]||(e[20]=[c("span",{style:{color:"#bbb"}},"Sin logo",-1)])))]),_:1}),s(b,{cols:"12",md:"6"},{default:o(()=>{var l,r;return[s(V,null,{default:o(()=>e[21]||(e[21]=[y("Logo")])),_:1}),s(xe,{ref:"fieldRefs.logo",modelValue:t.logo,"onUpdate:modelValue":[e[1]||(e[1]=n=>t.logo=n),e[2]||(e[2]=n=>C("logo"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact",required:"","show-size":"",multiple:!1,"error-messages":p.logo},null,8,["modelValue","error-messages"]),(r=(l=E(U).user)==null?void 0:l.roles)!=null&&r.includes("superadmin")?(_(),R(ae,{key:0},[s(V,null,{default:o(()=>e[22]||(e[22]=[y("Organización")])),_:1}),s(ze,{modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=n=>I.value=n),items:q.value,"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",searchable:!0,placeholder:"Buscar organización",required:""},null,8,["modelValue","items"])],64)):F("",!0),s(V,null,{default:o(()=>e[23]||(e[23]=[y("Nombre "),c("span",{class:"text-error"},"*",-1)])),_:1}),s(z,{ref:"fieldRefs.name",modelValue:t.name,"onUpdate:modelValue":[e[4]||(e[4]=n=>t.name=n),e[5]||(e[5]=n=>C("name"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",required:"","error-messages":p.name},null,8,["modelValue","error-messages"]),s(V,null,{default:o(()=>e[24]||(e[24]=[y("Alias")])),_:1}),s(z,{modelValue:t.alias,"onUpdate:modelValue":e[6]||(e[6]=n=>t.alias=n),variant:"outlined",color:"primary",class:"mt-2 mb-4"},null,8,["modelValue"]),s(V,null,{default:o(()=>e[25]||(e[25]=[y("Descripción")])),_:1}),s(we,{modelValue:t.description,"onUpdate:modelValue":e[7]||(e[7]=n=>t.description=n),variant:"outlined",color:"primary","auto-grow":"",rows:"3",class:"mt-2"},null,8,["modelValue"]),s(V,null,{default:o(()=>e[26]||(e[26]=[y("Zona Horaria "),c("span",{class:"text-error"},"*",-1)])),_:1}),s(le,{ref:"fieldRefs.timezone",modelValue:t.timezone,"onUpdate:modelValue":[e[8]||(e[8]=n=>t.timezone=n),e[10]||(e[10]=n=>C("timezone"))],items:ie.value,"search-input":T.value,"onUpdate:searchInput":e[9]||(e[9]=n=>T.value=n),"item-title":"label","item-value":"value",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una zona horaria",clearable:"","hide-details":"","menu-props":{maxHeight:"400px"},required:"","error-messages":p.timezone},null,8,["modelValue","items","search-input","error-messages"])]}),_:1}),s(b,{cols:"12",class:"mt-4"},{default:o(()=>[s(V,null,{default:o(()=>e[27]||(e[27]=[y("Dirección "),c("span",{class:"text-error"},"*",-1)])),_:1}),s(Re,{class:"mt-2","onUpdate:parsedAddress":me}),p.address?(_(),Y(z,{key:0,ref:"fieldRefs.address","model-value":"",variant:"outlined",color:"error",class:"mt-2","error-messages":p.address,readonly:"","hide-details":""},null,8,["error-messages"])):F("",!0)]),_:1})]),_:1}),s(D,{class:"mt-10"},{default:o(()=>[s(b,{cols:"12"},{default:o(()=>[e[28]||(e[28]=c("h4",{class:"font-weight-bold mb-3"},"Contacto",-1)),s(ee,{class:"mb-6"})]),_:1}),s(b,{cols:"12",sm:"6"},{default:o(()=>[s(V,null,{default:o(()=>e[29]||(e[29]=[y("Nombre")])),_:1}),s(z,{modelValue:t.person.first_name,"onUpdate:modelValue":e[11]||(e[11]=l=>t.person.first_name=l),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),s(b,{cols:"12",sm:"6"},{default:o(()=>[s(V,null,{default:o(()=>e[30]||(e[30]=[y("Apellido")])),_:1}),s(z,{modelValue:t.person.last_name,"onUpdate:modelValue":e[12]||(e[12]=l=>t.person.last_name=l),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),s(b,{cols:"12",sm:"6"},{default:o(()=>[s(V,null,{default:o(()=>e[31]||(e[31]=[y("Correo")])),_:1}),s(z,{modelValue:t.person.email,"onUpdate:modelValue":e[13]||(e[13]=l=>t.person.email=l),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),s(b,{cols:"12",sm:"6"},{default:o(()=>[s(V,null,{default:o(()=>e[32]||(e[32]=[y("Teléfono")])),_:1}),c("div",Le,[s(le,{ref:"fieldRefs.phone_country",modelValue:t.person.phone_country,"onUpdate:modelValue":[e[14]||(e[14]=l=>t.person.phone_country=l),e[16]||(e[16]=l=>C("phone_country"))],items:ue.value,"search-input":O.value,"onUpdate:searchInput":e[15]||(e[15]=l=>O.value=l),"item-title":"title","item-value":"value",variant:"outlined",color:"primary",density:"compact",class:"phone-country-field",placeholder:"País",clearable:"","hide-details":"","menu-props":{maxHeight:"400px",width:320},"error-messages":p.phone_country},{selection:o(({item:l})=>{var r;return[l&&l.value?(_(),R(ae,{key:0},[c("span",null,w((r=E(H)(l.value))==null?void 0:r.flag),1),c("span",Be,w(L(l.value,l.title)),1)],64)):F("",!0)]}),item:o(({item:l,props:r})=>[s(_e,he(ke(r)),{title:o(()=>{var n;return[c("div",De,[c("span",null,[c("span",null,w((n=E(H)(l.value))==null?void 0:n.flag),1),c("span",Pe,w(l.title.replace(/^.*?\s/,"")),1)]),c("span",Ne,w(L(l.value,l.title)),1)])]}),_:2},1040)]),_:1},8,["modelValue","items","search-input","error-messages"]),s(z,{modelValue:t.person.phone_number,"onUpdate:modelValue":e[17]||(e[17]=l=>t.person.phone_number=l),variant:"outlined",color:"primary",density:"compact",class:"phone-number-field",placeholder:"Número","hide-details":""},null,8,["modelValue"])])]),_:1})]),_:1}),s(D,null,{default:o(()=>[s(b,{cols:"12",class:"d-flex justify-end"},{default:o(()=>[s(X,{color:"primary",class:"mt-6",loading:A.value,disabled:A.value,onClick:pe},{loader:o(()=>[s(Ce,{indeterminate:"",color:"white",size:"20"})]),default:o(()=>[y(" "+w(A.value?"Creando Empresa...":"Crear Empresa"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),x.value?(_(),Y(Ae,{key:0,type:"error",class:"mt-6",variant:"outlined",density:"comfortable",style:{"max-width":"500px","margin-left":"auto"}},{default:o(()=>[y(w(x.value),1)]),_:1})):F("",!0)]),_:1},512)]),_:1})])):F("",!0)}},Ge=fe(Te,[["__scopeId","data-v-9bcc26f4"]]);export{Ge as default};
