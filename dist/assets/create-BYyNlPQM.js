import{_ as de,A as me,J as u,B as w,K as pe,a0 as ce,ah as ve,ai as L,L as K,s as B,l as F,a,w as n,V as $,b as c,d as v,f as ee,C as ae,al as fe,aj as ge,c as be,H as le,aw as m,e as r,aA as ye,u as se,b5 as Z,U as z,b4 as Ve,t as te,aq as xe,aB as we,a8 as ze,o as U}from"./index-DA8Oyi7H.js";import{j as Ue}from"./mdi-CCqP_oQm.js";import{t as ne,A as Ae}from"./timezones-D96QrXPD.js";const _e={key:0},ke=["src"],Ce={key:1,style:{width:"300px",height:"300px",display:"flex","align-items":"center","justify-content":"center",background:"#f5f5f5","border-radius":"12px"}},Be={__name:"create",setup(Se){const j=me(),I=ce(),V=u({}),N=u(null),y=u(""),Q=u(!1),O=u(""),d=w(()=>j.user);function P(l){return l?l.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}const f=w(()=>{var l,e;return(e=(l=d.value)==null?void 0:l.roles)==null?void 0:e.includes("superadmin")}),q=w(()=>{var l,e;return(e=(l=d.value)==null?void 0:l.roles)==null?void 0:e.includes("admin")}),oe=w(()=>{var l,e;return(e=(l=d.value)==null?void 0:l.roles)==null?void 0:e.includes("sponsor")}),A=w(()=>{var l,e;return q.value||oe.value||((e=(l=d.value)==null?void 0:l.permissions)==null?void 0:e.includes("businessUnit.create"))}),H=u([]),g=u(null),T=u(""),E=u(!1),S=u([]),x=u(null),R=u(""),M=u(!1);pe(async()=>{var l,e,s,p,k,C;Q.value=q.value||f.value||((e=(l=d.value)==null?void 0:l.permissions)==null?void 0:e.includes("businessUnit.create")),(s=d.value)!=null&&s.business_id&&!f.value&&!q.value&&!((k=(p=d.value)==null?void 0:p.permissions)!=null&&k.includes("businessUnit.viewAny"))&&I.replace(`/ubicaciones/${d.value.business_unit_id}`),f.value&&await W(""),A.value&&((C=d.value)!=null&&C.organization_id)&&(g.value=d.value.organization_id,await h("",d.value.organization_id))});const t=ve({legal_name:"",alias:"",description:"",timezone:"",logo:null,person:{first_name:"",last_name:"",email:"",phone_number:""}});L(()=>t.logo,l=>{let e=null;Array.isArray(l)?e=l.length>0?l[0]:null:(l instanceof File||l instanceof Blob)&&(e=l),N.value=e?URL.createObjectURL(e):null});const W=async l=>{E.value=!0;try{const{data:e}=await K.get("/organizations",{params:{q:l||"",limit:10}});H.value=(e.data||[]).map(s=>({...s,display:`${s.folio}${s.legal_name?" - "+s.legal_name:""}`,id:s.id}))}catch{H.value=[]}finally{E.value=!1}};L(T,l=>{f.value&&W(l)}),L(g,async l=>{x.value=null,l&&await h("",l)});const h=async(l,e)=>{if(!e){S.value=[];return}M.value=!0;try{const{data:s}=await K.get("/businesses",{params:{q:l||"",organization_id:e,limit:10}});S.value=(s.data||[]).map(p=>({...p,display:`${p.folio}${p.name?" - "+p.name:""}`,id:p.id}))}catch{S.value=[]}finally{M.value=!1}};L(R,l=>{g.value&&h(l,g.value)});const ie=l=>{V.value=l},ue=w(()=>{const l=P(O.value);return l?ne.filter(e=>P(e.label).includes(l)||P(e.value).includes(l)):ne}),_=u(!1),re=async()=>{var l,e,s,p,k,C,X;if(y.value="",!t.legal_name||!t.timezone||!V.value||Object.keys(V.value).length===0){y.value="Completa los campos obligatorios.";return}if(f.value&&!g.value){y.value="Selecciona una organización.";return}if((f.value||A.value)&&!x.value){y.value="Selecciona una empresa.";return}_.value=!0;try{const o=new FormData;o.append("legal_name",t.legal_name),o.append("alias",t.alias||""),o.append("description",t.description||""),o.append("timezone",t.timezone||"");let D=null;f.value?D=g.value:A.value&&(D=d.value.organization_id);let G=null;(f.value||A.value)&&x.value&&(G=x.value),D&&o.append("organization_id",D),G&&o.append("business_id",G);for(const i in V.value)V.value[i]&&o.append(`address[${i}]`,V.value[i]);if(Object.values(t.person).some(i=>{var Y;return((Y=i==null?void 0:i.trim)==null?void 0:Y.call(i))!==""}))for(const i in t.person)t.person[i]&&o.append(`person[${i}]`,t.person[i]);if(t.logo){const i=Array.isArray(t.logo)?t.logo[0]:t.logo;o.append("logo",i)}const b=await K.post("/business-units",o),J=((l=b==null?void 0:b.data)==null?void 0:l.id)||((s=(e=b==null?void 0:b.data)==null?void 0:e.business_unit)==null?void 0:s.id)||((k=(p=b==null?void 0:b.data)==null?void 0:p.data)==null?void 0:k.id);J?(j.user.business_unit_id=J,await j.fetchUser(),I.replace(`/ubicaciones/${J}`)):y.value="No se pudo obtener el ID de la ubicación creada."}catch(o){y.value=((X=(C=o==null?void 0:o.response)==null?void 0:C.data)==null?void 0:X.message)||"Error al crear la ubicación",console.error("❌ Error al crear la ubicación:",o)}finally{_.value=!1}};return(l,e)=>Q.value?(U(),B("div",_e,[a(ze,{fluid:""},{default:n(()=>[a($,{class:"align-center mb-6","no-gutters":""},{default:n(()=>[a(c,{cols:"auto",class:"d-flex align-center"},{default:n(()=>[a(ee,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:e[0]||(e[0]=s=>ae(I).back())},{default:n(()=>[a(fe,{icon:ae(Ue)},null,8,["icon"])]),_:1}),e[15]||(e[15]=v("h3",{class:"font-weight-medium ml-3 mb-0"},"Agregar Ubicación",-1))]),_:1})]),_:1}),a(ge,{class:"mb-10"},{default:n(()=>[a($,null,{default:n(()=>[a(c,{cols:"12"},{default:n(()=>[e[16]||(e[16]=v("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),a(le,{class:"mb-6"})]),_:1}),a(c,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:n(()=>[N.value?(U(),B("img",{key:0,src:N.value,alt:"Logo Preview",style:{"max-width":"300px","max-height":"300px","border-radius":"12px"}},null,8,ke)):(U(),B("div",Ce,e[17]||(e[17]=[v("span",{style:{color:"#bbb"}},"Sin logo",-1)])))]),_:1}),a(c,{cols:"12",md:"6"},{default:n(()=>[a(m,null,{default:n(()=>e[18]||(e[18]=[r("Logo")])),_:1}),a(ye,{modelValue:t.logo,"onUpdate:modelValue":e[1]||(e[1]=s=>t.logo=s),variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact","show-size":"",multiple:!1},null,8,["modelValue"]),f.value?(U(),B(se,{key:0},[a(m,null,{default:n(()=>e[19]||(e[19]=[r("Organización "),v("span",{class:"text-error"},"*",-1)])),_:1}),a(Z,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=s=>g.value=s),items:H.value,loading:E.value,"search-input":T.value,"onUpdate:searchInput":e[3]||(e[3]=s=>T.value=s),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Buscar organización",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"}},null,8,["modelValue","items","loading","search-input"]),e[20]||(e[20]=v("div",{style:{height:"16px"}},null,-1))],64)):F("",!0),g.value&&(f.value||A.value)?(U(),B(se,{key:1},[a(m,null,{default:n(()=>e[21]||(e[21]=[r("Empresa "),v("span",{class:"text-error"},"*",-1)])),_:1}),a(Z,{modelValue:x.value,"onUpdate:modelValue":e[4]||(e[4]=s=>x.value=s),items:S.value,loading:M.value,"search-input":R.value,"onUpdate:searchInput":e[5]||(e[5]=s=>R.value=s),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Buscar empresa",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"}},null,8,["modelValue","items","loading","search-input"]),e[22]||(e[22]=v("div",{style:{height:"16px"}},null,-1))],64)):F("",!0),a(m,null,{default:n(()=>e[23]||(e[23]=[r("Nombre Legal "),v("span",{class:"text-error"},"*",-1)])),_:1}),a(z,{modelValue:t.legal_name,"onUpdate:modelValue":e[6]||(e[6]=s=>t.legal_name=s),variant:"outlined",color:"primary",class:"mt-2 mb-4",required:""},null,8,["modelValue"]),a(m,null,{default:n(()=>e[24]||(e[24]=[r("Alias")])),_:1}),a(z,{modelValue:t.alias,"onUpdate:modelValue":e[7]||(e[7]=s=>t.alias=s),variant:"outlined",color:"primary",class:"mt-2 mb-4"},null,8,["modelValue"]),a(m,null,{default:n(()=>e[25]||(e[25]=[r("Descripción")])),_:1}),a(Ve,{modelValue:t.description,"onUpdate:modelValue":e[8]||(e[8]=s=>t.description=s),variant:"outlined",color:"primary","auto-grow":"",rows:"3",class:"mt-2"},null,8,["modelValue"]),a(m,null,{default:n(()=>e[26]||(e[26]=[r("Zona Horaria "),v("span",{class:"text-error"},"*",-1)])),_:1}),a(Z,{modelValue:t.timezone,"onUpdate:modelValue":e[9]||(e[9]=s=>t.timezone=s),items:ue.value,"search-input":O.value,"onUpdate:searchInput":e[10]||(e[10]=s=>O.value=s),"item-title":"label","item-value":"value",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una zona horaria",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},required:""},null,8,["modelValue","items","search-input"])]),_:1}),a(c,{cols:"12",class:"mt-4"},{default:n(()=>[a(m,null,{default:n(()=>e[27]||(e[27]=[r("Dirección "),v("span",{class:"text-error"},"*",-1)])),_:1}),a(Ae,{class:"mt-2","onUpdate:parsedAddress":ie})]),_:1})]),_:1}),a($,{class:"mt-10"},{default:n(()=>[a(c,{cols:"12"},{default:n(()=>[e[28]||(e[28]=v("h4",{class:"font-weight-bold mb-3"},"Contacto",-1)),a(le,{class:"mb-6"})]),_:1}),a(c,{cols:"12",sm:"6"},{default:n(()=>[a(m,null,{default:n(()=>e[29]||(e[29]=[r("Nombre")])),_:1}),a(z,{modelValue:t.person.first_name,"onUpdate:modelValue":e[11]||(e[11]=s=>t.person.first_name=s),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),a(c,{cols:"12",sm:"6"},{default:n(()=>[a(m,null,{default:n(()=>e[30]||(e[30]=[r("Apellido")])),_:1}),a(z,{modelValue:t.person.last_name,"onUpdate:modelValue":e[12]||(e[12]=s=>t.person.last_name=s),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),a(c,{cols:"12",sm:"6"},{default:n(()=>[a(m,null,{default:n(()=>e[31]||(e[31]=[r("Correo")])),_:1}),a(z,{modelValue:t.person.email,"onUpdate:modelValue":e[13]||(e[13]=s=>t.person.email=s),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),a(c,{cols:"12",sm:"6"},{default:n(()=>[a(m,null,{default:n(()=>e[32]||(e[32]=[r("Teléfono")])),_:1}),a(z,{modelValue:t.person.phone_number,"onUpdate:modelValue":e[14]||(e[14]=s=>t.person.phone_number=s),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1})]),_:1}),a($,null,{default:n(()=>[a(c,{cols:"12",class:"d-flex justify-end"},{default:n(()=>[a(ee,{color:"primary",class:"mt-6",loading:_.value,disabled:_.value,onClick:re},{loader:n(()=>[a(xe,{indeterminate:"",color:"white",size:"20"})]),default:n(()=>[r(" "+te(_.value?"Creando Ubicación...":"Crear Ubicación"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),y.value?(U(),be(we,{key:0,type:"error",class:"mt-6",variant:"outlined",density:"comfortable",style:{"max-width":"500px","margin-left":"auto"}},{default:n(()=>[r(te(y.value),1)]),_:1})):F("",!0)]),_:1})]),_:1})])):F("",!0)}},je=de(Be,[["__scopeId","data-v-d5784ec7"]]);export{je as default};
