import{J as h,L as I,A as le,B as re,K as de,aC as ue,ai as ce,c as g,s as c,C as t,aq as G,w as l,a as d,d as i,j as me,f as B,al as N,l as x,P as H,x as K,av as _e,b as C,t as v,U as ve,k as P,e as V,at as Q,u as R,v as O,V as pe,H as fe,G as ge,ab as ye,a0 as be,o as n,p as ke,m as xe,n as Ve}from"./index-DA8Oyi7H.js";import{F as Y,S as Ce}from"./constants-nBv8b9vA.js";import{j as he,a as ze,k as Se,l as Ne,i as Ee}from"./mdi-CCqP_oQm.js";function Le(){const T=h(null),q=h(!1),E=h(null);return{form:T,loading:q,error:E,fetchForm:async z=>{q.value=!0,E.value=null;try{const y=await I.get(`/forms/${z}`);T.value=y.data}catch(y){E.value=null,console.error("Error fetching organization:",y)}finally{q.value=!1}}}}const qe={class:"mb-4"},Ae={key:0,class:"text-subtitle-1 font-weight-medium"},Fe={class:"mb-4"},we={class:"mb-4"},De={key:0},Be={class:"mb-4"},Ie={key:0,class:"mb-4"},Te={key:1,class:"mb-4"},Ue={class:"mt-1"},$e={class:"mt-1"},Pe={class:"mt-1"},Re={class:"mb-4"},Oe={key:0,class:"mt-1"},Je={key:0,class:"d-flex align-center"},je={key:1,class:"text-grey"},Me={class:"mb-4"},Ge={key:0,class:"mt-1"},He={key:0},Ke={key:1,class:"text-grey"},Qe={class:"mb-4"},Ye={key:0,class:"mt-1"},We={key:0},Xe={key:1,class:"text-grey"},Ze={class:"mb-4"},es={key:0},ss={key:1,class:"text-center pa-4 text-grey"},as={key:2,class:"text-center pa-4 text-grey"},ns={__name:"ShowForm",setup(T){const q=ue(),E=be(),L=h(""),z=le(),y=h([]),A=h([]),W=()=>{E.push("/formularios")},J=()=>{E.push({name:"AddFieldsForm",params:{id:L.value},state:{form:s.value}})},j=re(()=>{var o,e;return(e=(o=z.user)==null?void 0:o.roles)==null?void 0:e.some(a=>a.name==="sponsor")}),X=o=>({organization:"blue",business:"green",business_unit:"orange"})[o]||"grey",Z=o=>{if(!o)return"No definido";const e=Ce.find(a=>a.value===o);return e?e.label:o},ee=o=>{const e=Y.find(a=>a.value===o);return e?e.label:o},M=o=>o?new Date(o).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"—";de(async()=>{L.value=q.params.id,L.value?(ae(L.value),await te()):console.warn("No form ID found to load")});const{form:s,loading:se,fetchForm:ae}=Le(),p=h(!1),u=h({});ce(s,async o=>{if(o){const e=y.value.find(_=>{var r;return(r=_.roles)==null?void 0:r.some(b=>{var f;return b.id===((f=o.supervisor_role)==null?void 0:f.id)})}),a=y.value.filter(_=>{var r;return(r=_.roles)==null?void 0:r.some(b=>{var f;return(f=o.auditor_roles)==null?void 0:f.some(k=>k.id===b.id)})}),m=y.value.filter(_=>{var r;return(r=_.roles)==null?void 0:r.some(b=>{var f;return(f=o.auditado_roles)==null?void 0:f.some(k=>k.id===b.id)})});u.value={name:o.name||"",frequency:o.frequency||"",supervisor_role_id:(e==null?void 0:e.id)||"",auditor_role_ids:a.map(_=>_.id)||[],auditado_role_ids:m.map(_=>_.id)||[],assignment_scope:o.assignment_scope||"",status:o.status||"draft"},await oe()}});const te=async()=>{try{const o=await I.get("/users");y.value=o.data.data.map(e=>{var a,m;return{...e,customLabel:`${((m=(a=e.roles)==null?void 0:a[0])==null?void 0:m.name)||"Sin rol"}`}})}catch(o){console.error("Error loading users:",o)}},oe=async()=>{var o;try{const e={scope:s.value.assignment_scope};s.value.assignment_scope==="business"&&s.value.business_id?e.business_id=s.value.business_id:s.value.assignment_scope==="business_unit"&&s.value.business_unit_id?e.business_unit_id=s.value.business_unit_id:s.value.assignment_scope==="organization"&&(e.organization_id=(o=z.user)==null?void 0:o.organization_id);const a=await I.get("/users-by-scope",{params:e});A.value=a.data.data.map(m=>{var _,r;return{...m,customLabel:`${((r=(_=m.roles)==null?void 0:_[0])==null?void 0:r.name)||"Sin rol"}`}})}catch(e){console.error("Error fetching users:",e),A.value=[]}},ie=()=>{var o,e,a;s.value&&(u.value={name:s.value.name||"",frequency:s.value.frequency||"",supervisor_role_id:((o=s.value.supervisor_role)==null?void 0:o.id)||"",auditor_role_ids:((e=s.value.auditor_roles)==null?void 0:e.map(m=>m.id))||[],auditado_role_ids:((a=s.value.auditado_roles)==null?void 0:a.map(m=>m.id))||[],assignment_scope:s.value.assignment_scope||"",status:s.value.status||"draft"}),p.value=!1},ne=async()=>{var o,e,a,m,_;try{const r=new FormData;r.append("name",u.value.name);const b=y.value.find(k=>k.id===u.value.supervisor_role_id);r.append("supervisor_role_id",((e=(o=b==null?void 0:b.roles)==null?void 0:o[0])==null?void 0:e.id)||""),u.value.auditor_role_ids&&u.value.auditor_role_ids.length>0&&u.value.auditor_role_ids.forEach((k,U)=>{var w,D;const S=A.value.find($=>$.id===k),F=(D=(w=S==null?void 0:S.roles)==null?void 0:w[0])==null?void 0:D.id;F&&r.append(`auditor_role_ids[${U}]`,F)}),u.value.auditado_role_ids&&u.value.auditado_role_ids.length>0&&u.value.auditado_role_ids.forEach((k,U)=>{var w,D;const S=A.value.find($=>$.id===k),F=(D=(w=S==null?void 0:S.roles)==null?void 0:w[0])==null?void 0:D.id;F&&r.append(`auditado_role_ids[${U}]`,F)}),r.append("frequency",u.value.frequency),r.append("assignment_scope",u.value.assignment_scope),r.append("status",u.value.status),u.value.assignment_scope==="organization"?r.append("organization_id",(a=z.user)==null?void 0:a.organization_id):u.value.assignment_scope==="business"?(r.append("business_id",s.value.business_id),r.append("organization_id",(m=z.user)==null?void 0:m.organization_id)):u.value.assignment_scope==="business_unit"&&(r.append("business_id",s.value.business_id),r.append("business_unit_id",s.value.business_unit_id),r.append("organization_id",(_=z.user)==null?void 0:_.organization_id));const f=await I.put(`/forms/${L.value}`,r,{headers:{"Content-Type":"multipart/form-data"}});s.value=f.data,u.value=JSON.parse(JSON.stringify(f.data)),p.value=!1}catch(r){console.error("Error updating form:",r)}};return(o,e)=>t(se)?(n(),g(G,{key:0,indeterminate:"",color:"primary"})):t(s)?(n(),g(ye,{key:1,class:"pa-6 rounded-lg elevation-3"},{default:l(()=>[d(_e,{class:"mb-4",density:"compact",title:"Detalles del Formulario"},me({_:2},[j.value?void 0:{name:"prepend",fn:l(()=>[d(B,{icon:"",onClick:W},{default:l(()=>[d(N,{icon:t(he)},null,8,["icon"])]),_:1})]),key:"0"},j.value?void 0:{name:"append",fn:l(()=>[d(H,{text:"Editar",location:"top"},{activator:l(({props:a})=>[d(B,K({icon:""},a,{onClick:e[0]||(e[0]=m=>p.value?ne():p.value=!0)}),{default:l(()=>[d(N,{icon:p.value?t(ze):t(Se)},null,8,["icon"])]),_:2},1040)]),_:1}),p.value?(n(),g(B,{key:0,icon:"",onClick:ie},{default:l(()=>[d(N,{icon:t(Ne)},null,8,["icon"])]),_:1})):x("",!0),d(H,{text:"Agregar nuevo campo",location:"top"},{activator:l(({props:a})=>[d(B,K({icon:""},a,{onClick:J}),{default:l(()=>[d(N,{icon:t(Ee)},null,8,["icon"])]),_:2},1040)]),_:1})]),key:"1"}]),1024),d(pe,{dense:""},{default:l(()=>[d(C,{cols:"12",md:"6"},{default:l(()=>[i("div",qe,[e[4]||(e[4]=i("strong",{class:"text-grey-darken-1"},"Nombre del Formulario:",-1)),p.value?(n(),g(ve,{key:1,modelValue:u.value.name,"onUpdate:modelValue":e[1]||(e[1]=a=>u.value.name=a),variant:"outlined",density:"compact"},null,8,["modelValue"])):(n(),c("div",Ae,v(t(s).name||"—"),1))]),i("div",Fe,[e[5]||(e[5]=i("strong",{class:"text-grey-darken-1"},"Alcance:",-1)),i("div",null,[d(P,{color:X(t(s).assignment_scope),size:"small",class:"mt-1",dark:""},{default:l(()=>[V(v(Z(t(s).assignment_scope)),1)]),_:1},8,["color"])])]),i("div",we,[e[6]||(e[6]=i("strong",{class:"text-grey-darken-1"},"Frecuencia:",-1)),p.value?(n(),g(Q,{key:1,modelValue:u.value.frequency,"onUpdate:modelValue":e[2]||(e[2]=a=>u.value.frequency=a),items:t(Y),"item-title":"label","item-value":"value",variant:"outlined",density:"compact","hide-details":"",class:"mt-1"},null,8,["modelValue","items"])):(n(),c("div",De,v(ee(t(s).frequency)||"—"),1))])]),_:1}),d(C,{cols:"12",md:"6"},{default:l(()=>[i("div",Be,[e[7]||(e[7]=i("strong",{class:"text-grey-darken-1"},"Estado:",-1)),i("div",null,[d(P,{color:t(s).status==="draft"?"green":"red",size:"small",class:"mt-1",dark:""},{default:l(()=>[V(v(t(s).status==="draft"?"Borrador":"Activo"),1)]),_:1},8,["color"])])]),t(s).created_at?(n(),c("div",Ie,[e[8]||(e[8]=i("strong",{class:"text-grey-darken-1"},"Fecha de Creación:",-1)),i("div",null,v(M(t(s).created_at)),1)])):x("",!0),t(s).updated_at?(n(),c("div",Te,[e[9]||(e[9]=i("strong",{class:"text-grey-darken-1"},"Última Actualización:",-1)),i("div",null,v(M(t(s).updated_at)),1)])):x("",!0)]),_:1}),t(s).assignment_scope==="organization"&&t(s).organization?(n(),g(C,{key:0,cols:"12"},{default:l(()=>[e[10]||(e[10]=i("strong",{class:"text-grey-darken-1"},"Organización:",-1)),i("div",Ue,v(t(s).organization.name),1)]),_:1})):x("",!0),t(s).assignment_scope==="business"&&t(s).business?(n(),g(C,{key:1,cols:"12"},{default:l(()=>[e[11]||(e[11]=i("strong",{class:"text-grey-darken-1"},"Negocio:",-1)),i("div",$e,v(t(s).business.name),1)]),_:1})):x("",!0),t(s).assignment_scope==="business_unit"&&t(s).business_unit?(n(),g(C,{key:2,cols:"12"},{default:l(()=>[e[12]||(e[12]=i("strong",{class:"text-grey-darken-1"},"Unidad de Negocio:",-1)),i("div",Pe,v(t(s).business_unit.name),1)]),_:1})):x("",!0),d(C,{cols:"12",md:"6"},{default:l(()=>[i("div",Re,[e[13]||(e[13]=i("strong",{class:"text-grey-darken-1"},"Supervisor:",-1)),p.value?x("",!0):(n(),c("div",Oe,[t(s).supervisor_role?(n(),c("div",Je,[i("span",null,v(t(s).supervisor_role.name),1)])):(n(),c("div",je,"No asignado"))]))])]),_:1}),d(C,{cols:"12",md:"6"},{default:l(()=>[i("div",Me,[e[14]||(e[14]=i("strong",{class:"text-grey-darken-1"},"Auditores:",-1)),p.value?x("",!0):(n(),c("div",Ge,[t(s).auditor_roles&&t(s).auditor_roles.length>0?(n(),c("div",He,[(n(!0),c(R,null,O(t(s).auditor_roles,a=>(n(),c("div",{key:a.id,class:"d-flex align-center mb-1"},[i("span",null,v(a.name),1)]))),128))])):(n(),c("div",Ke,"No asignados"))]))])]),_:1}),d(C,{cols:"12"},{default:l(()=>[i("div",Qe,[e[15]||(e[15]=i("strong",{class:"text-grey-darken-1"},"Auditados:",-1)),p.value?(n(),g(Q,{key:1,modelValue:u.value.auditado_role_ids,"onUpdate:modelValue":e[3]||(e[3]=a=>u.value.auditado_role_ids=a),items:A.value,multiple:"","item-title":"customLabel","item-value":"id",variant:"outlined",density:"compact","hide-details":"",class:"mt-1",label:"Selecciona a los Auditados"},null,8,["modelValue","items"])):(n(),c("div",Ye,[t(s).auditado_roles&&t(s).auditado_roles.length>0?(n(),c("div",We,[(n(!0),c(R,null,O(t(s).auditado_roles,a=>(n(),c("div",{key:a.id,class:"d-flex align-center mb-1"},[i("span",null,v(a.name),1)]))),128))])):(n(),c("div",Xe,"No asignados"))]))])]),_:1})]),_:1}),d(fe,{class:"my-6"}),i("div",Ze,[e[22]||(e[22]=i("h3",{class:"text-h6 mb-4"},"Campos del Formulario",-1)),t(s).fields&&t(s).fields.length>0?(n(),c("div",es,[d(ge,null,{default:l(()=>[(n(!0),c(R,null,O(t(s).fields,a=>(n(),g(ke,{key:a.id,class:"mb-2 border rounded"},{prepend:l(()=>[d(N,{class:"mr-2"},{default:l(()=>e[16]||(e[16]=[V("mdi-form-textbox")])),_:1})]),default:l(()=>[d(xe,{class:"font-weight-medium"},{default:l(()=>[V(v(a.label)+" ",1),a.is_required?(n(),g(P,{key:0,color:"red",size:"x-small",class:"ml-1"},{default:l(()=>e[17]||(e[17]=[V(" Requerido ")])),_:1})):x("",!0)]),_:2},1024),d(Ve,null,{default:l(()=>[V(" Tipo: "+v(a.type),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):(n(),c("div",ss,[d(N,{size:"large",class:"mb-2"},{default:l(()=>e[18]||(e[18]=[V("mdi-form-textbox")])),_:1}),e[21]||(e[21]=i("p",null,"No hay campos agregados a este formulario",-1)),d(B,{color:"primary",variant:"outlined",onClick:J,class:"mt-2"},{default:l(()=>[d(N,{class:"mr-2"},{default:l(()=>e[19]||(e[19]=[V("mdi-plus")])),_:1}),e[20]||(e[20]=V(" Agregar Campos "))]),_:1})]))])]),_:1})):(n(),c("div",as,[d(G,{indeterminate:"",color:"primary"})]))}};export{ns as default};
