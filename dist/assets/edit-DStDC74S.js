import{_ as me,aC as ce,A as fe,J as v,af as M,B as F,ag as G,an as pe,Z as ge,am as W,s as A,a as n,w as s,V as I,b as y,d as p,f as Z,C as j,aj as ve,ah as ye,c as J,l as T,H as Q,aw as b,e as g,aA as be,R as V,b4 as _e,b5 as K,p as Ve,b6 as he,b7 as ze,t as h,u as xe,aq as we,aB as X,a6 as ke,b8 as Ce,o as z}from"./index-BtdFDd_C.js";import{j as Ae}from"./mdi-CCqP_oQm.js";import{t as Y,A as Ue}from"./timezones--4UnaJtk.js";import{f as P,t as $e}from"./countries-Ba2Yp21G.js";const Re={key:0},Se=["src"],Ee={key:1,style:{width:"300px",height:"300px",display:"flex","align-items":"center","justify-content":"center",background:"#f5f5f5","border-radius":"12px"}},Fe={class:"phone-group phone-group-responsive mt-2"},Ie={style:{"margin-left":"6px"}},je={class:"d-flex align-center justify-space-between"},Le={style:{"margin-left":"8px"}},Be={class:"text-medium-emphasis"},De={key:1},Ne={__name:"edit",setup(Te){const L=ge(),U=ce().params.id,k=fe(),ee=v(null),c=v({}),$=v(null),_=v(""),B=v(""),D=v(""),C=v(!1),d=M({legal_name:"",timezone:"",address:"",logo:"",phone_country:""}),ae={legal_name:v(null),timezone:v(null),address:v(null),logo:v(null),phone_country:v(null)};function x(t){return t?t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function R(t=""){return x(String(t).replace(/\s*\(\+\d+\)\s*$/,"").trim())}function S(t,e=""){const a=P(t),r=(a==null?void 0:a.dial_code)??(a==null?void 0:a.calling_code)??(a==null?void 0:a.callingCode)??(a==null?void 0:a.phoneCode)??null;if(r)return String(r).startsWith("+")?r:`+${r}`;const m=String(e).match(/\(\+[\d]+\)/);return m&&m[0]?m[0].replace(/[()]/g,""):""}function te(t,e){const a=r=>{const m=S(r.value,r.title);let i=0;return m&&(i+=2),r.value&&(i+=1),String(r.value||"").length<=3&&(i+=1),i};return a(t)>=a(e)?t:e}function le(){const t=$e(),e=new Set,a=t.filter(i=>e.has(i.value)?!1:(e.add(i.value),!0)),r=new Map;for(const i of a){const o=R(i.title),f=r.get(o);f?r.set(o,te(f,i)):r.set(o,i)}const m=Array.from(r.values()).map(i=>({...i,title:i.title.replace(/\s*\(\+\d+\)\s*$/,"").trim()}));return m.sort((i,o)=>R(i.title).localeCompare(R(o.title))),m}const O=le(),oe=F(()=>{const t=x(B.value);return t?Y.filter(e=>x(e.label).includes(t)||x(e.value).includes(t)):Y}),ne=F(()=>{const t=x(D.value);return t?O.filter(e=>{const a=R(e.title),r=x(S(e.value,e.title));return a.includes(t)||r.includes(t)}):O}),se=F(()=>{var e,a,r;const t=k.user;return t?!!((e=t.roles)!=null&&e.includes("admin")||(a=t.roles)!=null&&a.includes("superadmin")||(r=t.permissions)!=null&&r.includes("organization.update")):!1}),l=M({legal_name:"",alias:"",description:"",logo:null,timezone:"",contact:{first_name:"",last_name:"",email:"",phone_country:"",phone_number:""}}),w=t=>{d[t]&&(d[t]="")},q=async t=>{await Ce();const e=ae[t];if(e&&e.value){const a=e.value.$el||e.value;a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),a.focus?a.focus():a.$el&&a.$el.focus&&a.$el.focus()}},E=(t,e)=>{switch(w(t),t){case"legal_name":if(!e||e.trim()==="")return d.legal_name="El nombre legal es obligatorio",!1;break;case"timezone":if(!e||e.trim()==="")return d.timezone="La zona horaria es obligatoria",!1;break;case"address":if(!c.value||Object.keys(c.value).length===0)return d.address="La dirección es obligatoria",!1;break;case"logo":break;case"phone_country":if(l.contact.phone_number&&!e)return d.phone_country="Selecciona el país para el teléfono",!1;break}return!0},re=async()=>{let t=!0,e=null;return E("legal_name",l.legal_name)||(t=!1,e||(e="legal_name")),E("timezone",l.timezone)||(t=!1,e||(e="timezone")),E("address",c.value)||(t=!1,e||(e="address")),E("phone_country",l.contact.phone_country)||(t=!1,e||(e="phone_country")),!t&&e&&await q(e),t};G(()=>l.logo,t=>{let e=null;Array.isArray(t)?e=t.length>0?t[0]:null:(t instanceof File||t instanceof Blob)&&(e=t),$.value=e?URL.createObjectURL(e):null});const ie=F(()=>{var t;return(t=c.value)!=null&&t.street?`${c.value.street} ${c.value.outdoor_number||""}`.trim():c.value?[c.value.neighborhood,c.value.city,c.value.state].filter(Boolean).join(", "):""}),ue=t=>{c.value=t,t&&Object.keys(t).length>0&&w("address")};G(()=>[l.legal_name,l.timezone,c.value,l.logo,l.contact.phone_country],()=>{_.value=""}),pe(async()=>{var a,r,m;const t=k.user;if(!(((a=t==null?void 0:t.roles)==null?void 0:a.includes("admin"))||((r=t==null?void 0:t.roles)==null?void 0:r.includes("superadmin"))||((m=t==null?void 0:t.permissions)==null?void 0:m.includes("organization.update")))){L.replace("/403");return}try{const i=await W.get(`/organizations/${U}`),o=i.data.organization||i.data.data||i.data;l.legal_name=o.legal_name||"",l.alias=o.alias||"",l.description=o.description||"",l.timezone=o.timezone||"",o.logo&&($.value=o.logo.startsWith("http")?o.logo:`/storage/${o.logo}`),o.address&&(c.value={street:o.address.street||"",outdoor_number:o.address.outdoor_number||"",indoor_number:o.address.indoor_number||"",neighborhood:o.address.neighborhood||"",postal_code:o.address.postal_code||"",city:o.address.city||"",state:o.address.state||"",country:o.address.country||""}),o.contact&&(l.contact.first_name=o.contact.first_name||"",l.contact.last_name=o.contact.last_name||"",l.contact.email=o.contact.email||"",l.contact.phone_number=o.contact.phone_number||"",l.contact.phone_country=o.contact.phone_country||"")}catch(i){console.error("❌ Error al cargar datos de organización",i)}});const de=async()=>{var t,e,a,r,m,i;if(_.value="",!!await re()){C.value=!0;try{const o=new FormData;o.append("legal_name",l.legal_name),o.append("alias",l.alias||""),o.append("description",l.description||""),o.append("timezone",l.timezone);for(const u in c.value)o.append(`address[${u}]`,c.value[u]||"");if(Object.values(l.contact).some(u=>u&&u.trim()!==""))for(const u in l.contact)o.append(`contact[${u}]`,l.contact[u]||"");if(l.logo){const u=Array.isArray(l.logo)?l.logo[0]:l.logo;o.append("logo",u)}await W.post(`/organizations/${U}?_method=PUT`,o),(t=k.user)!=null&&t.organization_id&&String(k.user.organization_id)===String(U)&&await k.fetchUser(),L.push(`/organizaciones/${U}`)}catch(o){if((a=(e=o==null?void 0:o.response)==null?void 0:e.data)!=null&&a.errors){const f=o.response.data.errors;let u=null;f.legal_name&&(d.legal_name=f.legal_name[0],u=u||"legal_name"),f.timezone&&(d.timezone=f.timezone[0],u=u||"timezone"),f.address&&(d.address=f.address[0],u=u||"address"),f.logo&&(d.logo=f.logo[0],u=u||"logo"),f.phone_country&&(d.phone_country=f.phone_country[0],u=u||"phone_country"),u&&await q(u);const H=Object.keys(f).filter(N=>!["legal_name","timezone","address","logo","phone_country"].includes(N));H.length>0&&(_.value=H.map(N=>f[N]).flat().join(" "))}else(m=(r=o==null?void 0:o.response)==null?void 0:r.data)!=null&&m.message?_.value=o.response.data.message:_.value="Error al actualizar organización";console.error("❌ Error al actualizar organización",((i=o.response)==null?void 0:i.data)||o)}finally{C.value=!1}}};return(t,e)=>se.value?(z(),A("div",Re,[n(ke,{fluid:""},{default:s(()=>[n(I,{class:"align-center mb-6","no-gutters":""},{default:s(()=>[n(y,{cols:"auto",class:"d-flex align-center"},{default:s(()=>[n(Z,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:e[0]||(e[0]=a=>j(L).back())},{default:s(()=>[n(ve,{icon:j(Ae)},null,8,["icon"])]),_:1}),e[17]||(e[17]=p("h3",{class:"font-weight-medium ml-3 mb-0"},"Editar Organización",-1))]),_:1})]),_:1}),n(ye,{ref_key:"Regform",ref:ee,"lazy-validation":"",class:"mb-10"},{default:s(()=>[n(I,null,{default:s(()=>[n(y,{cols:"12"},{default:s(()=>[e[18]||(e[18]=p("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),n(Q,{class:"mb-6"})]),_:1}),n(y,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:s(()=>[$.value?(z(),A("img",{key:0,src:$.value,alt:"Logo Preview",style:{"max-width":"300px","max-height":"300px","border-radius":"12px"}},null,8,Se)):(z(),A("div",Ee,e[19]||(e[19]=[p("span",{style:{color:"#bbb"}},"Sin logo",-1)])))]),_:1}),n(y,{cols:"12",md:"6"},{default:s(()=>[n(b,null,{default:s(()=>e[20]||(e[20]=[g("Logo")])),_:1}),n(be,{ref:"fieldRefs.logo",modelValue:l.logo,"onUpdate:modelValue":[e[1]||(e[1]=a=>l.logo=a),e[2]||(e[2]=a=>w("logo"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact","show-size":"",multiple:!1,"error-messages":d.logo},null,8,["modelValue","error-messages"]),n(b,null,{default:s(()=>e[21]||(e[21]=[g("Nombre Legal "),p("span",{class:"text-error"},"*",-1)])),_:1}),n(V,{ref:"fieldRefs.legal_name",modelValue:l.legal_name,"onUpdate:modelValue":[e[3]||(e[3]=a=>l.legal_name=a),e[4]||(e[4]=a=>w("legal_name"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",required:"","error-messages":d.legal_name},null,8,["modelValue","error-messages"]),n(b,null,{default:s(()=>e[22]||(e[22]=[g("Alias")])),_:1}),n(V,{modelValue:l.alias,"onUpdate:modelValue":e[5]||(e[5]=a=>l.alias=a),variant:"outlined",color:"primary",class:"mt-2 mb-4"},null,8,["modelValue"]),n(b,null,{default:s(()=>e[23]||(e[23]=[g("Descripción")])),_:1}),n(_e,{modelValue:l.description,"onUpdate:modelValue":e[6]||(e[6]=a=>l.description=a),variant:"outlined",color:"primary","auto-grow":"",rows:"3",class:"mt-2"},null,8,["modelValue"]),n(b,null,{default:s(()=>e[24]||(e[24]=[g("Zona Horaria "),p("span",{class:"text-error"},"*",-1)])),_:1}),n(K,{ref:"fieldRefs.timezone",modelValue:l.timezone,"onUpdate:modelValue":[e[7]||(e[7]=a=>l.timezone=a),e[9]||(e[9]=a=>w("timezone"))],items:oe.value,"search-input":B.value,"onUpdate:searchInput":e[8]||(e[8]=a=>B.value=a),"item-title":"label","item-value":"value",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una zona horaria",clearable:"","hide-details":"","menu-props":{maxHeight:"400px"},required:"","error-messages":d.timezone},null,8,["modelValue","items","search-input","error-messages"])]),_:1}),n(y,{cols:"12",class:"mt-4"},{default:s(()=>[n(b,null,{default:s(()=>e[25]||(e[25]=[g("Dirección "),p("span",{class:"text-error"},"*",-1)])),_:1}),n(Ue,{class:"mt-2","initial-value":c.value,placeholder:ie.value,"onUpdate:parsedAddress":ue},null,8,["initial-value","placeholder"]),d.address?(z(),J(V,{key:0,ref:"fieldRefs.address","model-value":"",variant:"outlined",color:"error",class:"mt-2","error-messages":d.address,readonly:"","hide-details":""},null,8,["error-messages"])):T("",!0)]),_:1})]),_:1}),n(I,{class:"mt-10"},{default:s(()=>[n(y,{cols:"12"},{default:s(()=>[e[26]||(e[26]=p("h4",{class:"font-weight-bold mb-3"},"Contacto",-1)),n(Q,{class:"mb-6"})]),_:1}),n(y,{cols:"12",sm:"6"},{default:s(()=>[n(b,null,{default:s(()=>e[27]||(e[27]=[g("Nombre")])),_:1}),n(V,{modelValue:l.contact.first_name,"onUpdate:modelValue":e[10]||(e[10]=a=>l.contact.first_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),n(y,{cols:"12",sm:"6"},{default:s(()=>[n(b,null,{default:s(()=>e[28]||(e[28]=[g("Apellido")])),_:1}),n(V,{modelValue:l.contact.last_name,"onUpdate:modelValue":e[11]||(e[11]=a=>l.contact.last_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),n(y,{cols:"12",sm:"6"},{default:s(()=>[n(b,null,{default:s(()=>e[29]||(e[29]=[g("Correo")])),_:1}),n(V,{modelValue:l.contact.email,"onUpdate:modelValue":e[12]||(e[12]=a=>l.contact.email=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),n(y,{cols:"12",sm:"6"},{default:s(()=>[n(b,null,{default:s(()=>e[30]||(e[30]=[g("Teléfono")])),_:1}),p("div",Fe,[n(K,{ref:"fieldRefs.phone_country",modelValue:l.contact.phone_country,"onUpdate:modelValue":[e[13]||(e[13]=a=>l.contact.phone_country=a),e[15]||(e[15]=a=>w("phone_country"))],items:ne.value,"search-input":D.value,"onUpdate:searchInput":e[14]||(e[14]=a=>D.value=a),"item-title":"title","item-value":"value",variant:"outlined",color:"primary",class:"phone-country-field",placeholder:"País",clearable:"","hide-details":"","menu-props":{maxHeight:"400px",width:320},"error-messages":d.phone_country},{selection:s(({item:a})=>{var r;return[a&&a.value?(z(),A(xe,{key:0},[p("span",null,h((r=j(P)(a.value))==null?void 0:r.flag),1),p("span",Ie,h(S(a.value,a.title)),1)],64)):T("",!0)]}),item:s(({item:a,props:r})=>[n(Ve,he(ze(r)),{title:s(()=>{var m;return[p("div",je,[p("span",null,[p("span",null,h((m=j(P)(a.value))==null?void 0:m.flag),1),p("span",Le,h(a.title.replace(/^.*?\s/,"")),1)]),p("span",Be,h(S(a.value,a.title)),1)])]}),_:2},1040)]),_:1},8,["modelValue","items","search-input","error-messages"]),n(V,{modelValue:l.contact.phone_number,"onUpdate:modelValue":e[16]||(e[16]=a=>l.contact.phone_number=a),variant:"outlined",color:"primary",class:"phone-number-field",placeholder:"Número","hide-details":""},null,8,["modelValue"])])]),_:1})]),_:1}),n(I,null,{default:s(()=>[n(y,{cols:"12",class:"d-flex justify-end"},{default:s(()=>[n(Z,{color:"primary",class:"mt-6",loading:C.value,disabled:C.value,onClick:de},{loader:s(()=>[n(we,{indeterminate:"",color:"white",size:"20"})]),default:s(()=>[g(" "+h(C.value?"Guardando...":"Guardar Cambios"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),_.value?(z(),J(X,{key:0,type:"error",class:"mt-6",variant:"outlined",density:"comfortable",style:{"max-width":"500px","margin-left":"auto"}},{default:s(()=>[g(h(_.value),1)]),_:1})):T("",!0)]),_:1},512)]),_:1})])):(z(),A("div",De,[n(X,{type:"error",class:"mt-10",variant:"outlined",density:"comfortable"},{default:s(()=>e[31]||(e[31]=[g(" No tienes acceso para editar esta organización. ")])),_:1})]))}},Ge=me(Ne,[["__scopeId","data-v-ed355994"]]);export{Ge as default};
