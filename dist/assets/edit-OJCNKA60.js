import{_ as oe,aC as ie,A as re,J as u,ah as ue,B as v,ai as D,K as de,L as z,c as K,s as h,w as n,a as l,b as d,d as w,f as W,C as N,a0 as me,al as pe,V as S,l as P,H as Z,aw as m,e as o,aA as ve,b5 as H,u as Q,U as A,b4 as ce,aB as X,t as fe,aj as ge,a8 as ye,o as b}from"./index-mAfd8qbF.js";import{j as be}from"./mdi-CCqP_oQm.js";import{t as Ve,A as _e}from"./timezones-C7h8mulV.js";const xe=["src"],ze={key:1,style:{width:"300px",height:"300px",display:"flex","align-items":"center","justify-content":"center",background:"#f5f5f5","border-radius":"12px"}},we={key:1},Ae={__name:"edit",setup(Ue){const R=me(),C=ie().params.id,j=re(),U=u([]),p=u(null),L=u(""),$=u(!1),V=u([]),_=u(null),O=u(""),B=u(!1),T=u(""),t=ue({legal_name:"",alias:"",description:"",timezone:"",logo:null,person:{first_name:"",last_name:"",email:"",phone_number:""}}),i=u({}),k=u(null),x=u(""),y=v(()=>j.user||{roles:[],permissions:[]}),E=v(()=>{var s,e;return Array.isArray(y.value.roles)?y.value.roles:((e=(s=y.value.roles)==null?void 0:s.map)==null?void 0:e.call(s,a=>a.name))||[]}),q=v(()=>{var s,e;return Array.isArray(y.value.permissions)?y.value.permissions:((e=(s=y.value.permissions)==null?void 0:s.map)==null?void 0:e.call(s,a=>a.name))||[]}),c=v(()=>E.value.includes("superadmin")),G=v(()=>E.value.includes("admin")),Y=v(()=>E.value.includes("sponsor")),I=v(()=>G.value||Y.value||q.value.includes("businessUnit.create")),ee=v(()=>c.value||G.value||q.value.includes("businessUnit.update")),ae=v(()=>{var s;return(s=i.value)!=null&&s.street?`${i.value.street} ${i.value.outdoor_number||""}`.trim():i.value?[i.value.neighborhood,i.value.city,i.value.state].filter(Boolean).join(", "):""}),le=async s=>{if(s){$.value=!0;try{const{data:e}=await z.get(`/organizations/${s}`);U.value=[{...e,display:`${e.folio}${e.legal_name?" - "+e.legal_name:""}`,id:e.id}]}catch{U.value=[]}finally{$.value=!1}}},se=async(s,e)=>{if(!(!s||!e)){B.value=!0;try{const{data:a}=await z.get(`/businesses/${s}`);V.value=[{...a,display:`${a.folio}${a.legal_name?" - "+a.legal_name:""}`,id:a.id}]}catch{V.value=[]}finally{B.value=!1}}},M=async s=>{$.value=!0;try{const{data:e}=await z.get("/organizations",{params:{q:s||"",limit:10}});U.value=(e.data||[]).map(a=>({...a,display:`${a.folio}${a.legal_name?" - "+a.legal_name:""}`,id:a.id}))}catch{U.value=[]}finally{$.value=!1}};D(L,s=>{c.value&&M(s)}),D(p,async s=>{_.value=null,s&&await F("",s)});const F=async(s,e)=>{if(!e){V.value=[];return}B.value=!0;try{const{data:a}=await z.get("/businesses",{params:{q:s||"",organization_id:e,limit:10}});V.value=(a.data||[]).map(f=>({...f,display:`${f.folio}${f.legal_name?" - "+f.legal_name:""}`,id:f.id}))}catch{V.value=[]}finally{B.value=!1}};D(O,s=>{p.value&&F(s,p.value)}),de(async()=>{try{const e=(await z.get(`/business-units/${C}`)).data;t.legal_name=e.legal_name||"",t.alias=e.alias||"",t.description=e.description||"",t.timezone=e.timezone||"",e.logo&&(k.value=e.logo.startsWith("http")?e.logo:`/storage/${e.logo}`),e.address&&(i.value={street:e.address.street||"",outdoor_number:e.address.outdoor_number||"",neighborhood:e.address.neighborhood||"",postal_code:e.address.postal_code||"",city:e.address.city||"",state:e.address.state||"",country:e.address.country||""}),e.person&&(t.person.first_name=e.person.first_name||"",t.person.last_name=e.person.last_name||"",t.person.email=e.person.email||"",t.person.phone_number=e.person.phone_number||""),e.organization_id&&(await le(e.organization_id),p.value=e.organization_id),e.business_id&&e.organization_id&&(await se(e.business_id,e.organization_id),_.value=e.business_id),c.value&&await M(""),(c.value||I.value)&&e.organization_id&&await F("",e.organization_id)}catch(s){console.error("❌ Error al cargar datos de ubicación",s)}}),D(()=>t.logo,s=>{let e=null;Array.isArray(s)?e=s.length>0?s[0]:null:(s instanceof File||s instanceof Blob)&&(e=s),k.value=e?URL.createObjectURL(e):k.value});const te=s=>{i.value=s},ne=async()=>{var a,f;if(x.value="",!t.legal_name||!i.value||Object.keys(i.value).length===0){x.value="Por favor completa el nombre legal y la dirección.";return}let s=null;if(c.value){if(!p.value){x.value="Selecciona una organización.";return}s=p.value}else I.value&&(s=y.value.organization_id);let e=null;(c.value||I.value)&&_.value&&(e=_.value);try{const r=new FormData;r.append("legal_name",t.legal_name),r.append("alias",t.alias||""),r.append("description",t.description||""),r.append("timezone",t.timezone||""),s&&r.append("organization_id",s),e&&r.append("business_id",e);for(const g in i.value)r.append(`address[${g}]`,i.value[g]||"");if(Object.values(t.person).some(g=>g&&g.trim()!==""))for(const g in t.person){const J=t.person[g];r.append(`person[${g}]`,typeof J=="string"?J:"")}t.logo&&(Array.isArray(t.logo)?r.append("logo",t.logo[0]):r.append("logo",t.logo)),await z.post(`/business-units/${C}?_method=PUT`,r),(a=j.user)!=null&&a.business_unit_id&&String(j.user.business_unit_id)===String(C)&&await j.fetchUser(),R.push(`/ubicaciones/${C}`)}catch(r){x.value="Error al actualizar ubicación",console.error("❌ Error al actualizar ubicación",((f=r.response)==null?void 0:f.data)||r)}};return(s,e)=>ee.value?(b(),K(ye,{key:0,fluid:""},{default:n(()=>[l(S,{class:"align-center mb-6","no-gutters":""},{default:n(()=>[l(d,{cols:"auto",class:"d-flex align-center"},{default:n(()=>[l(W,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:e[0]||(e[0]=a=>N(R).back())},{default:n(()=>[l(pe,{icon:N(be)},null,8,["icon"])]),_:1}),e[15]||(e[15]=w("h3",{class:"font-weight-medium ml-3 mb-0"},"Editar Ubicación",-1))]),_:1})]),_:1}),l(ge,{class:"mb-10"},{default:n(()=>[l(S,null,{default:n(()=>[l(d,{cols:"12"},{default:n(()=>[e[16]||(e[16]=w("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),l(Z,{class:"mb-6"})]),_:1}),l(d,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:n(()=>[k.value?(b(),h("img",{key:0,src:k.value,alt:"Logo Preview",style:{"max-width":"300px","max-height":"300px","border-radius":"12px"}},null,8,xe)):(b(),h("div",ze,e[17]||(e[17]=[w("span",{style:{color:"#bbb"}},"Sin logo",-1)])))]),_:1}),l(d,{cols:"12",md:"6"},{default:n(()=>[l(m,null,{default:n(()=>e[18]||(e[18]=[o("Logo")])),_:1}),l(ve,{modelValue:t.logo,"onUpdate:modelValue":e[1]||(e[1]=a=>t.logo=a),variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact","show-size":"",multiple:!1},null,8,["modelValue"]),c.value?(b(),h(Q,{key:0},[l(m,null,{default:n(()=>e[19]||(e[19]=[o("Organización")])),_:1}),l(H,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=a=>p.value=a),items:U.value,loading:$.value,"search-input":L.value,"onUpdate:searchInput":e[3]||(e[3]=a=>L.value=a),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Buscar organización",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"}},null,8,["modelValue","items","loading","search-input"]),e[20]||(e[20]=w("div",{style:{height:"16px"}},null,-1))],64)):P("",!0),p.value&&(c.value||I.value)?(b(),h(Q,{key:1},[l(m,null,{default:n(()=>e[21]||(e[21]=[o("Empresa")])),_:1}),l(H,{modelValue:_.value,"onUpdate:modelValue":e[4]||(e[4]=a=>_.value=a),items:V.value,loading:B.value,"search-input":O.value,"onUpdate:searchInput":e[5]||(e[5]=a=>O.value=a),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Buscar empresa",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"}},null,8,["modelValue","items","loading","search-input"]),e[22]||(e[22]=w("div",{style:{height:"16px"}},null,-1))],64)):P("",!0),l(m,null,{default:n(()=>e[23]||(e[23]=[o("Nombre Legal")])),_:1}),l(A,{modelValue:t.legal_name,"onUpdate:modelValue":e[6]||(e[6]=a=>t.legal_name=a),variant:"outlined",color:"primary",class:"mt-2 mb-4",required:""},null,8,["modelValue"]),l(m,null,{default:n(()=>e[24]||(e[24]=[o("Alias")])),_:1}),l(A,{modelValue:t.alias,"onUpdate:modelValue":e[7]||(e[7]=a=>t.alias=a),variant:"outlined",color:"primary",class:"mt-2 mb-4"},null,8,["modelValue"]),l(m,null,{default:n(()=>e[25]||(e[25]=[o("Descripción")])),_:1}),l(ce,{modelValue:t.description,"onUpdate:modelValue":e[8]||(e[8]=a=>t.description=a),variant:"outlined",color:"primary","auto-grow":"",rows:"3",class:"mt-2"},null,8,["modelValue"]),l(m,null,{default:n(()=>e[26]||(e[26]=[o("Zona Horaria")])),_:1}),l(H,{modelValue:t.timezone,"onUpdate:modelValue":e[9]||(e[9]=a=>t.timezone=a),items:N(Ve).map(a=>({label:a,value:a})),"search-input":T.value,"onUpdate:searchInput":e[10]||(e[10]=a=>T.value=a),"item-title":"label","item-value":"value",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una zona horaria",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"}},null,8,["modelValue","items","search-input"])]),_:1}),l(d,{cols:"12",class:"mt-4"},{default:n(()=>[l(m,null,{default:n(()=>e[27]||(e[27]=[o("Dirección")])),_:1}),l(_e,{class:"mt-2","initial-value":i.value,placeholder:ae.value,"onUpdate:parsedAddress":te},null,8,["initial-value","placeholder"])]),_:1})]),_:1}),l(S,{class:"mt-10"},{default:n(()=>[l(d,{cols:"12"},{default:n(()=>[e[28]||(e[28]=w("h4",{class:"font-weight-bold mb-3"},"Contacto",-1)),l(Z,{class:"mb-6"})]),_:1}),l(d,{cols:"12",sm:"6"},{default:n(()=>[l(m,null,{default:n(()=>e[29]||(e[29]=[o("Nombre")])),_:1}),l(A,{modelValue:t.person.first_name,"onUpdate:modelValue":e[11]||(e[11]=a=>t.person.first_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),l(d,{cols:"12",sm:"6"},{default:n(()=>[l(m,null,{default:n(()=>e[30]||(e[30]=[o("Apellido")])),_:1}),l(A,{modelValue:t.person.last_name,"onUpdate:modelValue":e[12]||(e[12]=a=>t.person.last_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),l(d,{cols:"12",sm:"6"},{default:n(()=>[l(m,null,{default:n(()=>e[31]||(e[31]=[o("Correo")])),_:1}),l(A,{modelValue:t.person.email,"onUpdate:modelValue":e[13]||(e[13]=a=>t.person.email=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),l(d,{cols:"12",sm:"6"},{default:n(()=>[l(m,null,{default:n(()=>e[32]||(e[32]=[o("Teléfono")])),_:1}),l(A,{modelValue:t.person.phone_number,"onUpdate:modelValue":e[14]||(e[14]=a=>t.person.phone_number=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1})]),_:1}),l(S,null,{default:n(()=>[l(d,{cols:"12",class:"d-flex justify-end"},{default:n(()=>[l(W,{color:"primary",class:"mt-6",onClick:ne},{default:n(()=>e[33]||(e[33]=[o("Guardar Cambios")])),_:1})]),_:1})]),_:1}),x.value?(b(),K(S,{key:0,class:"mt-4"},{default:n(()=>[l(d,{cols:"12"},{default:n(()=>[l(X,{type:"error",dense:""},{default:n(()=>[o(fe(x.value),1)]),_:1})]),_:1})]),_:1})):P("",!0)]),_:1})]),_:1})):(b(),h("div",we,[l(X,{type:"error",class:"mt-10",variant:"outlined",density:"comfortable"},{default:n(()=>e[34]||(e[34]=[o(" No tienes acceso para editar esta ubicación. ")])),_:1})]))}},Ce=oe(Ae,[["__scopeId","data-v-7e63dda5"]]);export{Ce as default};
