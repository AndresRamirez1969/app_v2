import{A as ce,J as o,ah as ae,K as S,B as $,ai as p,s as y,a as n,w as s,V as k,b as v,d as m,f as ie,C as le,a0 as fe,al as ge,aj as ve,c as be,l as J,H as ne,aw as c,e as d,aA as _e,U as se,u as te,b5 as z,t as oe,aq as ye,aB as re,a8 as ze,L as V,o as b}from"./index-mAfd8qbF.js";import{j as Ve}from"./mdi-CCqP_oQm.js";const xe={key:0},Ue=["src"],we={key:1,style:{width:"300px",height:"300px",display:"flex","align-items":"center","justify-content":"center",background:"#f5f5f5","border-radius":"12px"}},he={key:1},Re={__name:"create",setup(Se){const O=ce(),K=fe(),ue=o(null),H=o(null),_=o(""),Q=o(!1),P=o(""),j=o(""),E=o(""),R=o(""),A=o(""),x=o([]),q=o([]),B=o([]);o([]);const C=o([]),L=o([]),U=o(!1),N=o(!1),D=o(!1),M=o(!1),T=o(!1),f=o(null),I=ae({name:"",email:"",role:"",organization_id:""});o(null),o(null),o(null),o(null),S(()=>{var e;const i=O.user;Q.value=(e=i==null?void 0:i.permissions)==null?void 0:e.includes("user.create")});const a=ae({profile_picture:null,name:"",email:"",organization_id:null,business_id:null,business_unit_id:null,role:null,contact:{first_name:"",last_name:"",email:"",phone_number:""}}),g=$(()=>{var i,e;return(e=(i=O.user)==null?void 0:i.roles)==null?void 0:e.includes("superadmin")}),de=$(()=>{var i,e;return(e=(i=O.user)==null?void 0:i.roles)==null?void 0:e.includes("sponsor")}),W=$(()=>{var i;return(i=O.user)==null?void 0:i.organization_id});p(()=>a.profile_picture,i=>{let e=null;Array.isArray(i)?e=i.length>0?i[0]:null:(i instanceof File||i instanceof Blob)&&(e=i),H.value=e?URL.createObjectURL(e):null});const G=async(i="")=>{U.value=!0;try{const{data:e}=await V.get("/organizations",{params:{q:i,limit:10}});x.value=(e.data||[]).map(l=>({...l,display:`${l.folio}${l.legal_name?" - "+l.legal_name:""}`}))}catch{x.value=[]}finally{U.value=!1}};p(P,i=>{G(i)}),S(()=>G(""));const X=async(i="")=>{N.value=!0;try{const e={q:i,limit:10};a.organization_id&&(e.organization_id=a.organization_id);const{data:l}=await V.get("/businesses",{params:e});q.value=(l.data||[]).map(u=>({...u,display:`${u.folio}${u.legal_name?" - "+u.legal_name:""}`,organization_id:u.organization_id}))}catch{q.value=[]}finally{N.value=!1}};p([j,()=>a.organization_id],([i])=>{X(i)}),S(()=>X(""));const Y=async(i="")=>{D.value=!0;try{const e={q:i,limit:10};a.organization_id&&(e.organization_id=a.organization_id),a.business_id&&(e.business_id=a.business_id);const{data:l}=await V.get("/business-units",{params:e});B.value=(l.data||[]).map(u=>({...u,display:`${u.folio}${u.legal_name?" - "+u.legal_name:""}`,organization_id:u.organization_id,business_id:u.business_id}))}catch{B.value=[]}finally{D.value=!1}};p([E,()=>a.organization_id,()=>a.business_id],([i])=>{Y(i)}),S(()=>Y(""));const Z=async()=>{M.value=!0;try{const{data:i}=await V.get("/roles",{params:{q:R.value}});C.value=(i.data||[]).filter(e=>e.name!=="superadmin")}catch{C.value=[]}finally{M.value=!1}},ee=async i=>{T.value=!0;try{const{data:e}=await V.get("/roles",{params:{organization_id:i}});L.value=(e.data||[]).filter(l=>l.name!=="superadmin")}catch{L.value=[]}finally{T.value=!1}},me=$(()=>g.value?f.value?L.value.map(i=>({...i,display:i.name==="admin"?"Administrador":i.name==="sponsor"?"Sponsor":i.name})):[]:de.value?C.value.filter(i=>(i.organization_id===W.value||i.name==="sponsor")&&i.name!=="admin").map(i=>({...i,display:i.name==="sponsor"?"Sponsor":i.name})):C.value.filter(i=>i.organization_id===W.value||i.name==="admin"||i.name==="sponsor").map(i=>({...i,display:i.name==="admin"?"Administrador":i.name==="sponsor"?"Sponsor":i.name})));p(R,()=>{g.value?f.value&&ee(f.value):Z()}),S(()=>{g.value&&G(""),Z()}),p(f,i=>{g.value&&i&&(ee(i),a.role=null)}),p(()=>a.organization_id,i=>{i&&(a.business_id=null,a.business_unit_id=null)}),p(()=>a.business_id,i=>{i&&(a.organization_id=null,a.business_unit_id=null)}),p(()=>a.business_unit_id,i=>{i&&(a.organization_id=null,a.business_id=null)});const w=o(!1),pe=async()=>{var i,e,l,u;if(_.value="",w.value=!0,!a.name||!a.email||!a.role||!a.organization_id&&!a.business_id&&!a.business_unit_id){_.value="Por favor completa el nombre, correo, rol y selecciona organización, empresa o ubicación.";return}if(a.business_id&&!a.organization_id){const t=q.value.find(r=>r.id===a.business_id);t&&(a.organization_id=t.organization_id)}if(a.business_unit_id&&(!a.business_id||!a.organization_id)){const t=B.value.find(r=>r.id===a.business_unit_id);t&&(a.business_id=t.business_id,a.organization_id=t.organization_id)}try{const t=new FormData;if(t.append("name",a.name),t.append("email",a.email),t.append("role",a.role),a.organization_id&&t.append("organization_id",a.organization_id),a.business_id&&t.append("business_id",a.business_id),a.business_unit_id&&t.append("business_unit_id",a.business_unit_id),a.profile_picture){const h=Array.isArray(a.profile_picture)?a.profile_picture[0]:a.profile_picture;t.append("profile_picture",h)}for(const h in a.contact)a.contact[h]&&t.append(`contact[${h}]`,a.contact[h]);const r=await V.post("/users",t),F=r.data.user||r.data.data||r.data;F!=null&&F.id&&K.replace(`/usuarios/${F.id}`)}catch(t){if((e=(i=t==null?void 0:t.response)==null?void 0:i.data)!=null&&e.errors){const r=t.response.data.errors;r.name&&(I.name=r.name[0]),r.email&&(I.email=r.email[0]),r.role&&(I.role=r.role[0]),r.organization_id&&(I.organization_id=r.organization_id[0])}else(u=(l=t==null?void 0:t.response)==null?void 0:l.data)!=null&&u.message?_.value=t.response.data.message:_.value="Error al crear usuario";console.error("❌ Error al crear usuario:",t)}finally{w.value=!1}};return(i,e)=>Q.value?(b(),y("div",xe,[n(ze,{fluid:""},{default:s(()=>[n(k,{class:"align-center mb-6","no-gutters":""},{default:s(()=>[n(v,{cols:"auto",class:"d-flex align-center"},{default:s(()=>[n(ie,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:e[0]||(e[0]=l=>le(K).back())},{default:s(()=>[n(ge,{icon:le(Ve)},null,8,["icon"])]),_:1}),e[16]||(e[16]=m("h3",{class:"font-weight-medium ml-3 mb-0"},"Agregar Usuario",-1))]),_:1})]),_:1}),n(ve,{ref_key:"Regform",ref:ue,"lazy-validation":"",class:"mb-10"},{default:s(()=>[n(k,null,{default:s(()=>[n(v,{cols:"12"},{default:s(()=>[e[17]||(e[17]=m("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),n(ne,{class:"mb-6"})]),_:1}),n(v,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:s(()=>[H.value?(b(),y("img",{key:0,src:H.value,alt:"Profile Preview",style:{"max-width":"300px","max-height":"300px","border-radius":"12px"}},null,8,Ue)):(b(),y("div",we,e[18]||(e[18]=[m("span",{style:{color:"#bbb"}},"Sin foto",-1)])))]),_:1}),n(v,{cols:"12",md:"6"},{default:s(()=>[n(c,null,{default:s(()=>e[19]||(e[19]=[d("Foto de Perfil")])),_:1}),n(_e,{modelValue:a.profile_picture,"onUpdate:modelValue":e[1]||(e[1]=l=>a.profile_picture=l),variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact","show-size":"",multiple:!1},null,8,["modelValue"]),n(c,null,{default:s(()=>e[20]||(e[20]=[d("Nombre "),m("span",{class:"text-error"},"*",-1)])),_:1}),n(se,{modelValue:a.name,"onUpdate:modelValue":e[2]||(e[2]=l=>a.name=l),variant:"outlined",color:"primary",class:"mt-2 mb-4",required:""},null,8,["modelValue"]),n(c,null,{default:s(()=>e[21]||(e[21]=[d("Correo "),m("span",{class:"text-error"},"*",-1)])),_:1}),n(se,{modelValue:a.email,"onUpdate:modelValue":e[3]||(e[3]=l=>a.email=l),variant:"outlined",color:"primary",class:"mt-2 mb-4",required:""},null,8,["modelValue"]),g.value?(b(),y(te,{key:0},[n(c,null,{default:s(()=>e[22]||(e[22]=[d("Organización para filtrar roles")])),_:1}),n(z,{modelValue:f.value,"onUpdate:modelValue":e[4]||(e[4]=l=>f.value=l),items:x.value,loading:U.value,"search-input":A.value,"onUpdate:searchInput":e[5]||(e[5]=l=>A.value=l),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una organización",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},required:""},null,8,["modelValue","items","loading","search-input"])],64)):J("",!0),e[25]||(e[25]=m("div",{style:{height:"22px"}},null,-1)),g.value?(b(),y(te,{key:1},[n(c,null,{default:s(()=>e[23]||(e[23]=[d("Organización para filtrar roles")])),_:1}),n(z,{modelValue:f.value,"onUpdate:modelValue":e[6]||(e[6]=l=>f.value=l),items:x.value,loading:U.value,"search-input":A.value,"onUpdate:searchInput":e[7]||(e[7]=l=>A.value=l),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una organización",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},required:""},null,8,["modelValue","items","loading","search-input"])],64)):J("",!0),e[26]||(e[26]=m("div",{style:{height:"22px"}},null,-1)),n(c,null,{default:s(()=>e[24]||(e[24]=[d("Rol "),m("span",{class:"text-error"},"*",-1)])),_:1}),n(z,{modelValue:a.role,"onUpdate:modelValue":e[8]||(e[8]=l=>a.role=l),items:me.value,loading:g.value?T.value:M.value,"search-input":R.value,"onUpdate:searchInput":e[9]||(e[9]=l=>R.value=l),"item-title":"display","item-value":"name",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona un rol",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},required:""},null,8,["modelValue","items","loading","search-input"])]),_:1})]),_:1}),n(k,null,{default:s(()=>[n(v,{cols:"12"},{default:s(()=>[e[27]||(e[27]=m("h4",{class:"font-weight-bold mb-3"},"Pertenece a",-1)),n(ne,{class:"mb-6"})]),_:1})]),_:1}),n(k,null,{default:s(()=>[n(v,{cols:"12",md:"12"},{default:s(()=>[n(c,null,{default:s(()=>e[28]||(e[28]=[d("Organización "),m("span",{class:"text-error"},"*",-1)])),_:1}),n(z,{modelValue:a.organization_id,"onUpdate:modelValue":e[10]||(e[10]=l=>a.organization_id=l),items:x.value,loading:U.value,"search-input":P.value,"onUpdate:searchInput":e[11]||(e[11]=l=>P.value=l),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una organización",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},disabled:!!a.business_id||!!a.business_unit_id,required:"!form.business_id && !form.business_unit_id"},null,8,["modelValue","items","loading","search-input","disabled"]),n(c,null,{default:s(()=>e[29]||(e[29]=[d("Empresa")])),_:1}),n(z,{modelValue:a.business_id,"onUpdate:modelValue":e[12]||(e[12]=l=>a.business_id=l),items:q.value,loading:N.value,"search-input":j.value,"onUpdate:searchInput":e[13]||(e[13]=l=>j.value=l),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-6",density:"compact",placeholder:"Selecciona una empresa",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},disabled:!!a.organization_id||!!a.business_unit_id,required:"!form.organization_id && !form.business_unit_id"},null,8,["modelValue","items","loading","search-input","disabled"]),n(c,null,{default:s(()=>e[30]||(e[30]=[d("Ubicación")])),_:1}),n(z,{modelValue:a.business_unit_id,"onUpdate:modelValue":e[14]||(e[14]=l=>a.business_unit_id=l),items:B.value,loading:D.value,"search-input":E.value,"onUpdate:searchInput":e[15]||(e[15]=l=>E.value=l),"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2",density:"compact",placeholder:"Selecciona una ubicación",clearable:"","hide-details":"","menu-props":{maxHeight:"300px"},disabled:!!a.organization_id||!!a.business_id,required:"!form.organization_id && !form.business_id"},null,8,["modelValue","items","loading","search-input","disabled"])]),_:1})]),_:1}),n(k,null,{default:s(()=>[n(v,{cols:"12",class:"d-flex justify-end"},{default:s(()=>[n(ie,{color:"primary",class:"mt-6",loading:w.value,disabled:w.value,onClick:pe},{loader:s(()=>[n(ye,{indeterminate:"",color:"white",size:"20"})]),default:s(()=>[d(" "+oe(w.value?"Creando Usuario...":"Crear Usuario"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),_.value?(b(),be(re,{key:0,type:"error",class:"mt-6",variant:"outlined",density:"comfortable",style:{"max-width":"500px","margin-left":"auto"}},{default:s(()=>[d(oe(_.value),1)]),_:1})):J("",!0)]),_:1},512)]),_:1})])):(b(),y("div",he,[n(re,{type:"error",class:"mt-10",variant:"outlined",density:"comfortable"},{default:s(()=>e[31]||(e[31]=[d(" No tienes permiso para crear usuarios. ")])),_:1})]))}};export{Re as default};
