import{_ as fe,aC as ce,A as ge,J as y,ah as Z,B as q,ai as ye,K as ve,L as H,c as M,s as E,w as r,a as o,b,d as c,f as X,C as F,a0 as be,al as Ve,V as P,l as B,H as Y,aw as V,e as g,aA as _e,at as he,u as ee,U as w,b4 as ze,b5 as ae,p as xe,b6 as we,b7 as ke,t as k,aq as Ce,aB as se,aj as Ue,a8 as Ae,b8 as $e,o as z}from"./index-DA8Oyi7H.js";import{j as Se}from"./mdi-CCqP_oQm.js";import{t as oe,A as Ee}from"./timezones-D96QrXPD.js";import{f as G,t as Fe}from"./countries-Ba2Yp21G.js";const Re=["src"],Ie={key:1,style:{width:"300px",height:"300px",display:"flex","align-items":"center","justify-content":"center",background:"#f5f5f5","border-radius":"12px"}},je={class:"phone-group mt-2"},Le={style:{"margin-left":"6px"}},Pe={class:"d-flex align-center justify-space-between"},Be={style:{"margin-left":"8px"}},De={class:"text-medium-emphasis"},Ne={key:1},Te={__name:"edit",setup(Oe){const W=be(),R=ce().params.id,x=ge(),D=y([]),$=y(null),N=y(""),T=y(""),_=y({}),S=y(null),h=y(""),C=y(!1),m=Z({name:"",timezone:"",address:"",logo:"",phone_country:""}),te={name:y(null),timezone:y(null),address:y(null),logo:y(null),phone_country:y(null)},t=Z({name:"",alias:"",description:"",timezone:"",logo:null,person:{first_name:"",last_name:"",email:"",phone_country:"",phone_number:""}});function U(s){return s?s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():""}function I(s=""){return U(String(s).replace(/\s*\(\+\d+\)\s*$/,"").trim())}function j(s,e=""){const a=G(s),n=(a==null?void 0:a.dial_code)??(a==null?void 0:a.calling_code)??(a==null?void 0:a.callingCode)??(a==null?void 0:a.phoneCode)??null;if(n)return String(n).startsWith("+")?n:`+${n}`;const l=String(e).match(/\(\+[\d]+\)/);return l&&l[0]?l[0].replace(/[()]/g,""):""}function le(s,e){const a=n=>{const l=j(n.value,n.title);let u=0;return l&&(u+=2),n.value&&(u+=1),String(n.value||"").length<=3&&(u+=1),u};return a(s)>=a(e)?s:e}function re(){const s=Fe(),e=new Set,a=s.filter(u=>e.has(u.value)?!1:(e.add(u.value),!0)),n=new Map;for(const u of a){const v=I(u.title),i=n.get(v);i?n.set(v,le(i,u)):n.set(v,u)}const l=Array.from(n.values()).map(u=>({...u,title:u.title.replace(/\s*\(\+\d+\)\s*$/,"").trim()}));return l.sort((u,v)=>I(u.title).localeCompare(I(v.title))),l}const J=re(),ne=q(()=>{const s=U(N.value);return s?oe.filter(e=>U(e.label).includes(s)||U(e.value).includes(s)):oe}),ie=q(()=>{const s=U(T.value);return s?J.filter(e=>{const a=I(e.title),n=U(j(e.value,e.title));return a.includes(s)||n.includes(s)}):J}),ue=q(()=>{var e,a,n;const s=x.user;return s?!!((e=s.roles)!=null&&e.includes("admin")||(a=s.roles)!=null&&a.includes("superadmin")||(n=s.permissions)!=null&&n.includes("business.update")):!1});function A(s){m[s]&&(m[s]="")}async function K(s){await $e();const e=te[s];if(e&&e.value){const a=e.value.$el||e.value;a.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),a.focus?a.focus():a.$el&&a.$el.focus&&a.$el.focus()}}function L(s,e){switch(A(s),s){case"name":if(!e||e.trim()==="")return m.name="El nombre es obligatorio",!1;break;case"timezone":if(!e||e.trim()==="")return m.timezone="La zona horaria es obligatoria",!1;break;case"address":if(!_.value||Object.keys(_.value).length===0)return m.address="La dirección es obligatoria",!1;break;case"logo":break;case"phone_country":if(t.person.phone_number&&!e)return m.phone_country="Selecciona el país para el teléfono",!1;break}return!0}const de=async()=>{let s=!0,e=null;return L("name",t.name)||(s=!1,e||(e="name")),L("timezone",t.timezone)||(s=!1,e||(e="timezone")),L("address",_.value)||(s=!1,e||(e="address")),L("phone_country",t.person.phone_country)||(s=!1,e||(e="phone_country")),!s&&e&&await K(e),s};ye(()=>t.logo,s=>{let e=null;Array.isArray(s)?e=s.length>0?s[0]:null:(s instanceof File||s instanceof Blob)&&(e=s),S.value=e?URL.createObjectURL(e):S.value});const me=s=>{_.value=s,s&&Object.keys(s).length>0&&A("address")};ve(async()=>{var s;try{const e=await H.get(`/businesses/${R}`),a=e.data.business||e.data.data||e.data;t.name=a.name||"",t.alias=a.alias||"",t.description=a.description||"",t.timezone=a.timezone||"",t.logo=null,S.value=a.logo?a.logo.startsWith("http")?a.logo:`/storage/${a.logo}`:null,a.address&&(_.value={street:a.address.street||"",outdoor_number:a.address.outdoor_number||"",indoor_number:a.address.indoor_number||"",neighborhood:a.address.neighborhood||"",postal_code:a.address.postal_code||"",city:a.address.city||"",state:a.address.state||"",country:a.address.country||"",latitude:a.address.latitude||"",longitude:a.address.longitude||"",geofence_radius:a.address.geofence_radius||""}),a.person&&(t.person.first_name=a.person.first_name||"",t.person.last_name=a.person.last_name||"",t.person.email=a.person.email||"",t.person.phone_country=a.person.phone_country||"",t.person.phone_number=a.person.phone_number||"");const n=x.user;if((s=n==null?void 0:n.roles)!=null&&s.includes("superadmin"))try{const l=await H.get("/organizations"),u=Array.isArray(l.data)?l.data:l.data.data;D.value=u.map(v=>({...v,display:`${v.folio||""} - ${v.legal_name||""}`.trim()})),$.value=a.organization_id||null}catch{D.value=[]}}catch(e){h.value="Error al cargar datos de empresa",console.error("❌ Error al cargar datos de empresa",e)}});const pe=async()=>{var s,e,a,n,l,u,v;if(h.value="",!!await de()){C.value=!0;try{const i=new FormData;i.append("name",t.name),i.append("alias",t.alias||""),i.append("description",t.description||""),i.append("timezone",t.timezone);const d=x.user;let p=null;if((s=d==null?void 0:d.roles)!=null&&s.includes("superadmin")){if(!$.value){h.value="Selecciona una organización.",C.value=!1;return}p=$.value}else(e=d==null?void 0:d.permissions)!=null&&e.includes("business.update")&&(p=d.organization_id);p&&i.append("organization_id",p);for(const f in _.value)i.append(`address[${f}]`,_.value[f]||"");if(Object.values(t.person).some(f=>{var Q;return((Q=f==null?void 0:f.trim)==null?void 0:Q.call(f))!==""}))for(const f in t.person)i.append(`person[${f}]`,t.person[f]||"");if(t.logo){const f=Array.isArray(t.logo)?t.logo[0]:t.logo;i.append("logo",f)}await H.post(`/businesses/${R}?_method=PUT`,i),(a=x.user)!=null&&a.business_id&&String(x.user.business_id)===String(R)&&await x.fetchUser(),W.replace(`/empresas/${R}`)}catch(i){if((l=(n=i==null?void 0:i.response)==null?void 0:n.data)!=null&&l.errors){const d=i.response.data.errors;let p=null;d.name&&(m.name=d.name[0],p=p||"name"),d.timezone&&(m.timezone=d.timezone[0],p=p||"timezone"),d.address&&(m.address=d.address[0],p=p||"address"),d.logo&&(m.logo=d.logo[0],p=p||"logo"),d.phone_country&&(m.phone_country=d.phone_country[0],p=p||"phone_country"),p&&await K(p);const O=Object.keys(d).filter(f=>!["name","timezone","address","logo","phone_country"].includes(f));O.length>0&&(h.value=O.map(f=>d[f]).flat().join(" "))}else(v=(u=i==null?void 0:i.response)==null?void 0:u.data)!=null&&v.message?h.value=i.response.data.message:h.value="Error al actualizar empresa";console.error("❌ Error al actualizar empresa",i)}finally{C.value=!1}}};return(s,e)=>ue.value?(z(),M(Ae,{key:0,fluid:""},{default:r(()=>[o(P,{class:"align-center mb-6","no-gutters":""},{default:r(()=>[o(b,{cols:"auto",class:"d-flex align-center"},{default:r(()=>[o(X,{icon:"",variant:"text",class:"px-3 py-2",style:{"border-radius":"8px",border:"1px solid #ccc"},onClick:e[0]||(e[0]=a=>F(W).back())},{default:r(()=>[o(Ve,{icon:F(Se)},null,8,["icon"])]),_:1}),e[18]||(e[18]=c("h3",{class:"font-weight-medium ml-3 mb-0"},"Editar Empresa",-1))]),_:1})]),_:1}),o(Ue,{class:"mb-10"},{default:r(()=>[o(P,null,{default:r(()=>[o(b,{cols:"12"},{default:r(()=>[e[19]||(e[19]=c("h4",{class:"font-weight-bold mb-3"},"Información General",-1)),o(Y,{class:"mb-6"})]),_:1}),o(b,{cols:"12",md:"6",class:"d-flex flex-column align-center justify-center",style:{"min-height":"300px"}},{default:r(()=>[S.value?(z(),E("img",{key:0,src:S.value,alt:"Logo Preview",style:{"max-width":"300px","max-height":"300px","border-radius":"12px"}},null,8,Re)):(z(),E("div",Ie,e[20]||(e[20]=[c("span",{style:{color:"#bbb"}},"Sin logo",-1)])))]),_:1}),o(b,{cols:"12",md:"6"},{default:r(()=>{var a,n;return[o(V,null,{default:r(()=>e[21]||(e[21]=[g("Logo")])),_:1}),o(_e,{ref:"fieldRefs.logo",modelValue:t.logo,"onUpdate:modelValue":[e[1]||(e[1]=l=>t.logo=l),e[2]||(e[2]=l=>A("logo"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",accept:"image/*",density:"compact","show-size":"",multiple:!1,"error-messages":m.logo},null,8,["modelValue","error-messages"]),(n=(a=F(x).user)==null?void 0:a.roles)!=null&&n.includes("superadmin")?(z(),E(ee,{key:0},[o(V,null,{default:r(()=>e[22]||(e[22]=[g("Organización")])),_:1}),o(he,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=l=>$.value=l),items:D.value,"item-title":"display","item-value":"id",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",searchable:!0,placeholder:"Buscar organización",required:""},null,8,["modelValue","items"])],64)):B("",!0),o(V,null,{default:r(()=>e[23]||(e[23]=[g("Nombre "),c("span",{class:"text-error"},"*",-1)])),_:1}),o(w,{ref:"fieldRefs.name",modelValue:t.name,"onUpdate:modelValue":[e[4]||(e[4]=l=>t.name=l),e[5]||(e[5]=l=>A("name"))],variant:"outlined",color:"primary",class:"mt-2 mb-4",required:"","error-messages":m.name},null,8,["modelValue","error-messages"]),o(V,null,{default:r(()=>e[24]||(e[24]=[g("Alias")])),_:1}),o(w,{modelValue:t.alias,"onUpdate:modelValue":e[6]||(e[6]=l=>t.alias=l),variant:"outlined",color:"primary",class:"mt-2 mb-4"},null,8,["modelValue"]),o(V,null,{default:r(()=>e[25]||(e[25]=[g("Descripción")])),_:1}),o(ze,{modelValue:t.description,"onUpdate:modelValue":e[7]||(e[7]=l=>t.description=l),variant:"outlined",color:"primary","auto-grow":"",rows:"3",class:"mt-2"},null,8,["modelValue"]),o(V,null,{default:r(()=>e[26]||(e[26]=[g("Zona Horaria "),c("span",{class:"text-error"},"*",-1)])),_:1}),o(ae,{ref:"fieldRefs.timezone",modelValue:t.timezone,"onUpdate:modelValue":[e[8]||(e[8]=l=>t.timezone=l),e[10]||(e[10]=l=>A("timezone"))],items:ne.value,"search-input":N.value,"onUpdate:searchInput":e[9]||(e[9]=l=>N.value=l),"item-title":"label","item-value":"value",variant:"outlined",color:"primary",class:"mt-2 mb-4",density:"compact",placeholder:"Selecciona una zona horaria",clearable:"","hide-details":"","menu-props":{maxHeight:"400px"},required:"","error-messages":m.timezone},null,8,["modelValue","items","search-input","error-messages"])]}),_:1}),o(b,{cols:"12",class:"mt-4"},{default:r(()=>[o(V,null,{default:r(()=>e[27]||(e[27]=[g("Dirección "),c("span",{class:"text-error"},"*",-1)])),_:1}),o(Ee,{class:"mt-2","initial-value":_.value,"onUpdate:parsedAddress":me},null,8,["initial-value"]),m.address?(z(),M(w,{key:0,ref:"fieldRefs.address","model-value":"",variant:"outlined",color:"error",class:"mt-2","error-messages":m.address,readonly:"","hide-details":""},null,8,["error-messages"])):B("",!0)]),_:1})]),_:1}),o(P,{class:"mt-10"},{default:r(()=>[o(b,{cols:"12"},{default:r(()=>[e[28]||(e[28]=c("h4",{class:"font-weight-bold mb-3"},"Contacto",-1)),o(Y,{class:"mb-6"})]),_:1}),o(b,{cols:"12",sm:"6"},{default:r(()=>[o(V,null,{default:r(()=>e[29]||(e[29]=[g("Nombre")])),_:1}),o(w,{modelValue:t.person.first_name,"onUpdate:modelValue":e[11]||(e[11]=a=>t.person.first_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),o(b,{cols:"12",sm:"6"},{default:r(()=>[o(V,null,{default:r(()=>e[30]||(e[30]=[g("Apellido")])),_:1}),o(w,{modelValue:t.person.last_name,"onUpdate:modelValue":e[12]||(e[12]=a=>t.person.last_name=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),o(b,{cols:"12",sm:"6"},{default:r(()=>[o(V,null,{default:r(()=>e[31]||(e[31]=[g("Correo")])),_:1}),o(w,{modelValue:t.person.email,"onUpdate:modelValue":e[13]||(e[13]=a=>t.person.email=a),variant:"outlined",color:"primary",class:"mt-2"},null,8,["modelValue"])]),_:1}),o(b,{cols:"12",sm:"6"},{default:r(()=>[o(V,null,{default:r(()=>e[32]||(e[32]=[g("Teléfono")])),_:1}),c("div",je,[o(ae,{ref:"fieldRefs.phone_country",modelValue:t.person.phone_country,"onUpdate:modelValue":[e[14]||(e[14]=a=>t.person.phone_country=a),e[16]||(e[16]=a=>A("phone_country"))],items:ie.value,"search-input":T.value,"onUpdate:searchInput":e[15]||(e[15]=a=>T.value=a),"item-title":"title","item-value":"value",variant:"outlined",color:"primary",density:"compact",class:"phone-country-field",placeholder:"País",clearable:"","hide-details":"","menu-props":{maxHeight:"400px",width:320},"error-messages":m.phone_country},{selection:r(({item:a})=>{var n;return[a&&a.value?(z(),E(ee,{key:0},[c("span",null,k((n=F(G)(a.value))==null?void 0:n.flag),1),c("span",Le,k(j(a.value,a.title)),1)],64)):B("",!0)]}),item:r(({item:a,props:n})=>[o(xe,we(ke(n)),{title:r(()=>{var l;return[c("div",Pe,[c("span",null,[c("span",null,k((l=F(G)(a.value))==null?void 0:l.flag),1),c("span",Be,k(a.title.replace(/^.*?\s/,"")),1)]),c("span",De,k(j(a.value,a.title)),1)])]}),_:2},1040)]),_:1},8,["modelValue","items","search-input","error-messages"]),o(w,{modelValue:t.person.phone_number,"onUpdate:modelValue":e[17]||(e[17]=a=>t.person.phone_number=a),variant:"outlined",color:"primary",density:"compact",class:"phone-number-field",placeholder:"Número","hide-details":""},null,8,["modelValue"])])]),_:1})]),_:1}),o(P,null,{default:r(()=>[o(b,{cols:"12",class:"d-flex justify-end"},{default:r(()=>[o(X,{color:"primary",class:"mt-6",loading:C.value,disabled:C.value,onClick:pe},{loader:r(()=>[o(Ce,{indeterminate:"",color:"white",size:"20"})]),default:r(()=>[g(" "+k(C.value?"Guardando...":"Guardar Cambios"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),h.value?(z(),M(se,{key:0,type:"error",class:"mt-6",variant:"outlined",density:"comfortable",style:{"max-width":"500px","margin-left":"auto"}},{default:r(()=>[g(k(h.value),1)]),_:1})):B("",!0)]),_:1})]),_:1})):(z(),E("div",Ne,[o(se,{type:"error",class:"mt-10",variant:"outlined",density:"comfortable"},{default:r(()=>e[33]||(e[33]=[g(" No tienes acceso para editar esta empresa. ")])),_:1})]))}},Je=fe(Te,[["__scopeId","data-v-8979e178"]]);export{Je as default};
